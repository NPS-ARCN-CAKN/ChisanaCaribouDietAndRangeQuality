---
title: ""
author: ""
date: ""
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
---

```{r setup, include=FALSE, echo=FALSE}

# Global NA to blank
options(knitr.kable.NA = '')
knitr::opts_chunk$set(echo = FALSE)

# Libraries
library(sqldf)
library(tidyverse)
library(odbc)
library(leaflet)
library(ggspatial)
library(sf)

# Paths to CAKN drive data and Data Store Project Reference
# J:\Monitoring\Caribou\WRST\Projects\Chisana Caribou Habitat Assessment
# https://irma.nps.gov/DataStore/Reference/Profile/2306144

# Directory where project deliverables are stored (authoritative copies will eventually go in Data Store)
DeliverablesDirectory = "J:/Monitoring/Caribou/WRST/Projects/Chisana Caribou Habitat Assessment/Data/Deliverables/"

# Initiate table and figure counters
TableCounter = 2
FigureCounter = 1

```

```{r, echo=FALSE}
# This code block is not used analytically but rather to get the the data from the database and written to files that can be archived and made available in Data Store. I want the analysis in this report to come from files rather than the database so that the code can easily be reproduced by anybody using files in Data Store rather than the database. The code in this chunk will be commented out entirely once the files are written and is only included to show how the data files were generated.

# Database connection 
connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna_dev", Database = "ChisanaVegetation")

# Function to Write a data frame to a file in the deliverables directory. This will be used as data is pulled from the database and written to files for archival in Data Store
WriteDataFrameToFile = function(DataFrame,Filename){
  ExportFile = paste(DeliverablesDirectory,Filename,sep="")
  #write.table(DataFrame,file=ExportFile,quote=TRUE,sep=",",na="",row.names = FALSE, col.names = TRUE)
}

# Write the vegetation dataset to file
# ----------------------------------------------------------------------------
Sql = "SELECT Plot
, Line
, PointLoc
, TopCanopy
, TopCanopyScientificName
, TopCanopyCommonName
, TopCanopyLifeForm
, TopCanopyGrowthHabit
, TopCanopyGrowthHabitSub
, Lower1
, Lower1ScientificName
, Lower1CommonName
, Lower1LifeForm
, Lower1GrowthHabit
, Lower1GrowthHabitSub
, Lower2
, Lower2ScientificName
, Lower2CommonName
, Lower2LifeForm
, Lower2GrowthHabit
, Lower2GrowthHabitSub
, Lower3
, Lower3ScientificName
, Lower3CommonName
, Lower3LifeForm
, Lower3GrowthHabit
, Lower3GrowthHabitSub
, SoilSurface
, SoilSurfaceScientificName
, SoilSurfaceCommonName
, SoilSurfaceLifeForm
, SoilSurfaceGrowthHabit
, SoilSurfaceGrowthHabitSub
, SoilSurfaceDescription
, LichenHeight
, Ecotype
, Lat
, Lon
, Elev_m
, SlopePosition
, SlopeLength
, SlopeCrossSection
, ParentRock
, Drainage
, AvgPrecip
, AvgPrecipUOM
, EcolSite
, ParentMaterial
, MicroRelief
, MicroReliefSize
, GeoMorphicDisturbance
, EvidenceOfFrostAction
, MaxSlope
, EvidenceOfWind
, WindExposureClass
, CaribouSign
, EvidenceOfFire
, SlopeAsp
, Date
, Crew
, EcotypeID
, VersionDate
FROM Dataset_VegData
ORDER BY Plot, Line, PointLoc"
Dataset_VegData = dbGetQuery(connection,Sql)

#Write the vegetation data to file
#Filename = paste("CV-10 Chisana Range Vegetation Dataset.csv",sep="")
#WriteDataFrameToFile(Dataset_VegData,Filename)

# Get metadata for the dataset above
#Metadata = dbGetQuery(connection,"SELECT [Column],[Definition] FROM Dataset_VegData_Metadata")
#MetadataFilename = paste("CV-10 Chisana Range Vegetation Dataset ",Sys.Date()," Metadata - Column Descriptions.csv",sep="")
#WriteDataFrameToFile(Metadata,MetadataFilename)





# Write the sampling plots dataset to file
# ----------------------------------------------------------------------------
# Plots = dbGetQuery(connection,"SELECT  Plots.Plot
# , Ecotypes.Ecotype
# , Plots.EstablishDate
# , Plots.Crew
# , Plots.Elev_m
# , Plots.Lat
# as Latitude
# , Plots.Lon as Longitude
# , Plots.NTransectLitterType
# , Plots.NTransectLitterDepth
# , Plots.SETransectLitterType
# , Plots.SETransectLitterDepth
# , Plots.SWTransectLitterType
# , Plots.SWTransectLitterDepth
# , Plots.CaribouSign
# , Plots.SlopePosition
# , Plots.SlopeCrossSection
# , Plots.Drainage
# , Plots.MicroRelief
# , Plots.MicroReliefSize
# , Plots.ParentRock
# , Plots.ParentMaterial
# , Plots.GeoMorphicDisturbance
# , Plots.EvidenceOfFrostAction
# , Plots.EvidenceOfFire
# , Plots.EvidenceOfWind
# , Plots.WindExposureClass
# , Plots.SlopeLength
# , Plots.AvgPrecip
# , Plots.AvgPrecipUOM
# , Plots.EcolSite
# , Plots.MaxSlope
# , Plots.SlopeAsp
# , Plots.Notes
# , Plots.EcotypeID
# FROM Plots 
# INNER JOIN Ecotypes ON Plots.EcotypeID = Ecotypes.EcotypeID
# WHERE (NOT (Plots.EstablishDate IS NULL)) -- Exclude plots that have not yet been surveyed.
# ORDER BY Plots.Plot")

# Write the sampling plots to file
#Filename = paste("CV-10 Plots.csv",sep="")
#WriteDataFrameToFile(Plots,Filename)




# Write the ecotypes dataset to file
# ----------------------------------------------------------------------------
#Ecotypes = dbGetQuery(connection,"SELECT Ecotype, DistinguishingFeatures, Cover, EcotypeID FROM Ecotypes ORDER BY Ecotype")
#Filename = paste("CV-10 Ecotypes.csv",sep="")
#WriteDataFrameToFile(Ecotypes,Filename)





# Write the species list dataset to file
# ----------------------------------------------------------------------------
#SpeciesList = dbGetQuery(connection,"SELECT [Family]
#       ,[Genus]
#       ,[Species]
#       ,[ScientificName]
#       ,[CommonName]
#       ,[LifeForm]
#       ,[GrowthHabit]
#       ,[GrowthHabitSub]
#       ,[synonymOf]
#       ,[GrowthHabitCode]
#       ,[Duration]
#       ,[Stabilizing]
#       ,[Invasive]
#       ,[Notes]
#       ,[SpeciesCode]
#   FROM [ChisanaVegetation].[dbo].[SpeciesList] 
#   ORDER BY ScientificName")
# Filename = paste("CV-10 Species List.csv",sep="")
#WriteDataFrameToFile(SpeciesList,Filename)




# Write the deliverables schedule to file
# ----------------------------------------------------------------------------
#DeliverablesSchedule = dbGetQuery(connection,"SELECT * FROM DeliverablesSchedule ORDER BY DeliverableID")
# Write the deliverables schedule plots to file
#Filename = paste("C-00 Deliverables Schedule - Chisana Vegetation Project.csv",sep="")
#WriteDataFrameToFile(DeliverablesSchedule,Filename)




# Write the fecal pellet dataset to file
# ----------------------------------------------------------------------------

# Notes on data processing steps to get to a good pellet dataset:
# The lab shipped a file to JAP (Putera 34 results.xlsx). The data was good in a pivoted, wide format that was untidy. 
# I cleaned it (Putera 34 results Copy.xlsx) and reformatted into a long and tidy (2015 Chisana Caribou Fecal Pellet Data.xlsx) format and imported it into the database (inpyugamsvm01\nuna_dev:ChisanaVeg).

# There were also a number of geodatabases containing the pellet collection locations. I merged these into a single file, CP-07 Fecal pellet collections spatial dataset.csv and imported them into the database.
# From there I joined the fecal composition data with the pellet collection locations joining on Sample and exported a pellet composition dataset with spatial locations for upload to Data Store: CP-05 Chisana Caribou Fecal Pellet Composition Dataset.csv; in the database this dataset is the view Dataset_FecalPellets).

# Get the fecal pellet dataset
# Sql = "SELECT  Sample, Form, Plant, PctComposition, Date, Year, Month, Lat, Lon, Elevation_m, Comment
# FROM Dataset_FecalPellets
# ORDER BY Sample, Form, Plant"
# PelletData = dbGetQuery(connection,Sql)
# Filename = paste("CP-05 Fecal pellet dataset.csv",sep="")
# WriteDataFrameToFile(PelletData,Filename)

```

```{r, echo=FALSE}
# Read in the Chisana vegetation dataset
Dataset_VegData = read.csv(paste(DeliverablesDirectory,"CV-10 Chisana Range Vegetation Dataset.csv",sep=""),header=TRUE)

# Read in the sampling plots dataset
Plots = read.csv(paste(DeliverablesDirectory,"CV-10 Plots.csv",sep=""),header=TRUE)

# Read in the ecotypes dataset
Ecotypes  = read.csv(paste(DeliverablesDirectory,"CV-10 Ecotypes.csv",sep=""),header=TRUE)

# Read in the fecal pellet dataset
PelletData  = read.csv(paste(DeliverablesDirectory,"CP-05 Fecal pellet dataset.csv",sep=""),header=TRUE)

# Read in the species list and species code abbreviations
SpeciesList  = read.csv(paste(DeliverablesDirectory,"CV-10 Species List.csv",sep=""),header=TRUE)

```

# Range Characterization and Diet of the Chisana Caribou Herd, Alaska

Authors, etc.

## Wrangell-St. Elias National Park and Preserve

# Abstract

[to be written]

# Introduction

The Chisana Caribou Herd (CCH) is a small herd of woodland caribou located in northeastern Wrangell St. Elias (WRST) National Park and Preserve in Alaska and the Tetlin National Wildlife Refuge in the Yukon. During the early 1990s, many caribou herds in interior Alaska experienced population declines of varying severity (Valkenburg et al., 1996). From 1989 to 2001, the CCH population dropped from an estimated 1800 to 400 individuals (R. Farnell, unpublished data). The CCH became listed as a “Specially Protected” population in 2002 under the Yukon’s Federal Species at Risk Act. After the implementation of a captive rearing program and the development of an international, multiagency management plan, the CCH population is now stable and open to subsistence hunting. However, the current population is significantly below pre-decline levels. Several factors most likely contributed to the CCH population decline including predation, low recruitment, and poor habitat.

Lichens may be the greatest feature limiting CCH habitat quality. Lichens comprise up to 60-86% of the winter diets of Yukon woodland caribou herds, while moss makes up only 1-8%, as estimated from the microhistological analysis of fecal pellets (Farnell and Gardner, 2002). Relative to other Alaskan and Yukon caribou, the CCH appear to have a winter diet that is unusually and low in lichen (31%) and high in moss (51%). Overflight landcover assessments and collections from a limited number of plots suggest that lichen cover with the range is sparse and dominated by nutrient-poor Stereocaulon species (Clarke and Waterreus, 2012), an indicator of poor winter habitat for reindeer (Swanson and Barker, 1992). More data on lichen and moss cover with the CCH range are needed to corroborate these results. In addition to cover, lichen biomass is an important measurement of caribou forage quality. If overgrazing occurs, lichen biomass may not be correlated with lichen cover, and caribou have shown preference for regions with low lichen cover, but high lichen biomass (Collins et al., 2010). Lichen biomass is commonly estimated from mean lichen mat thickness (Lieb, 1994; Arseneault et al., 1997; Moen et al. 2007; Collins et al., 2010). Therefore, measuring lichen thickness and cover in the CCH range may capture key details for assessing winter habitat.

Summer forage is also an important component of caribou habitat. Low recruitment in caribou populations in the Southern Alaska Peninsula is thought to be due to a combination of low winter lichen availability and poor summer range quality (Post and Klein, 1999). Caribou summer diet is typically composed of grasses, sedges, forbs, and willows (Boertje, 1984). Manipulation experiments within the CCH range suggest that climate change may affect caribou summer forage quality and abundance (Lenart et al., 2002). In this study, we aim to establish baseline monitoring of vegetation within the CCH range. Secondly, we estimate lichen cover and biomass across the CCH range to assess habitat quality relative to those of other caribou, particularly the neighboring Kluane, Aishihik, and Nelchina herds. In this report, we describe results from first season of data collection, present preliminary findings, and offer recommendations for future study years.

# Methods

## Study Area

We focus on the core range of the CCH within WRST National Park and Preserve boundaries. This area forms the basin between the Wrangell, St. Elias, and Nutzotin Mountains, containing the Chisana and White Rivers and the historic town of Chisana. Study area limits were defined to include the bulk of CCH radio collar signals recorded between 1988 and 2015 (Fig. 1; J. Putera, unpublished data, 2015). The resulting area is 2795 km^2^ (1079 miles^2^ ) and contains moderate to high elevations, from 1000 - 2500 m (3281–8202 ft).

## Vegetation Cover

We chose to proportionally allocate sampling sites to six major ecotypes within the study area (Table 1). Major ecotypes were developed by consolidating the detailed ecotypes mapped in WRST by Jorgenson et al. (2008) using satellite imagery. We grouped Jorgenson et al. ecotypes into groups based on the similarity of their definitions and geographic size (Table 1; Fig. 2). We included all ecotypes except for glaciated barrens. In our study region, the three most common ecotypes by percent cover are Alpine Dwarf Shrub/Barrens (28.1%), Subalpine Wood/Shrub (28.1%), and Alpine Sedge-Dwarf Shrub (24.3%). Riverine, Alpine Meadow, and Forest ecotypes make up the remaining 19.4% of the region.

Figure 1. Defining the core range of the Chisana caribou herd in northeastern WRST Park and Preserve. Points are radio collar signals recorded from 1988 to 2015 during summer or winter seasons. The core range (yellow border) was selected to include the majority of radio signals within WRST (green border).

Figure 2. Major ecotypes within the Chisana caribou range in northeastern WRST Park and Preserve (Table 1). Map based on ecotype landcover developed by Jorgenson et al. (2008).

We generated 56 random points for site locations within the Chisana caribou herd range. We included a 3000 m buffer between sites to ensure an even geographic distribution throughout the study area (geographic locations of sites are listed in Appendix A). Points that fell within rivers were moved to the nearest accessible riverine ecotype and points on excessively steep terrain were eliminated. We re-assigned ecotypes after field data collection using the formal WSRT ecotype classification key (summarized in Table 1; Jorgenson et al., 2008). We visited 23 sites in July, 2015 and 10 sites in July, 2016. Sites were accessed by helicopter or foot using a Trimble or Garmin GPS for navigation (Fig. 3). Permanent plots were established at all sites except those falling with a proposed Archeological District around Wiki Peak. Permanent plots were marked with a 60 cm-long rebar located at plot centers. At each site, we described physical landscape characteristics such as slope position, drainage, and geomorphic disturbance. We recorded vegetation along three 20 m-long transects oriented at 0, 120, and 240° from the plot center. Each transect was photographed and measured for slope. Transects were systematically sampled at 50 cm intervals using the line-point intercept method. At each point, we recorded all intercepted overstory and understory taxa, soil surface cover, and lichen height. Lichen height was measured using a 3 mm-wide metal skewer inserted into the base of the lichen mat (Arseneault et al., 1997; Moen et al. 2007; Collins et al., 2010). We calculated the mean lichen height of each plot as the average of all heights, including zero heights where no lichen was present. Litter depth was sampled from 10 cm-diameter soil plugs removed at the terminus of each transect. Our litter depth measurements include the height of any living mat-forming vegetation, such as moss (See Appendix B for detailed field measurement protocol).

We identified taxa to the species or genus-level. We considered forage lichen as the genera Cladina, Cladonia (excluding species with cup-shaped podetia), Cetraria (excluding C. richardsonii), and Stereocaulon, following Collins et al. (2011). We estimated the percent cover of major life forms across the entire study area as the average of ecotype means weighted by ecotype area.

```{r, include=TRUE}

# NOTES: It appears that Merkhofer took Jorgenson et al. 2008's landcover classification and merged various subecotypes together into larger ecotypes. The Major ecotype column in Table 1, below, is Merkhofer's ecotype derived from the 'Included detailed ecotypes' which come from Jorgenson.

# Merkhofer documented her GIS work well in \\inpyugamsstor00\Primary Datapool\I&M\CAKN\CAKN2\Monitoring\Caribou\WRST\Projects\Chisana Caribou Habitat Assessment\Data\Habitat\Chisana Vegetation Sampling\)

# Merkhofer's steps as I can reproduce them:

# 1. She loaded Jorgenson's landcover into a geodatabase: J:\Monitoring\Caribou\WRST\Projects\Chisana Caribou Habitat Assessment\Data\Habitat\GIS\ChisanaCaribouHabitat.gdb as WRSTEcotypes2008Chisana

# 2. She combined various cover classes into larger major ecotypes and added a SamplingGroup column (example SWB corresponding to Subalpine Wood/Shrub)

# 3. These merged major ecotypes became a feature class Ecotypes_in_one_shapefile. This layer is what is shown in Figure 2 of the Merkhofer, 2015 report

# 4. She then chose potential veg plot locations in the major ecotypes for locating sampling plots (Chisana_Veg_Sampling_Points in the geodatabase, APPENDIX A. RANDOM SITE LOCATIONS AND STUDY STATUS in her report)


```

## Ecotypes

Table 1. Ecotypes of Chisana caribou herd range, ranked by percent cover.

+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
|       | **Major ecotype**          | **Included detailed ecotypes\*** | **Distinguishing features**                                                                                                                  | **Landcover** |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 1     | Alpine Dwarf-Shrub/Barrens | Alpine Dryas Dwarf Shrub         | *Dryas* spp. and other evergreen dwarf shrubs dominant, trees or tall shrubs absent, and rare graminoids; occurs at high elevations          | 28.1%         |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Barrens                   |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Ericaeous Dwarf Shrub     |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 2     | Subalpine Wood/Shrub       | Subalpine Willow-Birch Shrub     | Characterized by tall (\> 0.2 m) deciduous shrubs; few sedges and grasses; tree cover \< 20%                                                 | 28.1%         |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Subalpine Spruce Woodland        |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 3     | Alpine Sedge-Dwarf Shrub   | Alpine Sedge-Dwarf Willow Meadow | Deciduous shrubs dominant, but with lower frequencies than in ecotype 2; sedges co-dominant; trees absent; relatively high species diversity | 24.3%         |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 4     | Riverine                   | Riverine Circumalkaline Barrens  | On or near braided streams; deciduous or evergreen dwarf shrubs are dominant and trees uncommon                                              | 7.5%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Sandy Willow Shrub      |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Dryas Dwarf Shrub       |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Tall Alder Shrub        |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Low Silverberry Shrub   |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 5     | Alpine Meadow              | Alpine Tussock Meadow            | Tussocks \> 25% and sedge cover approaching 60%; dwarf shrubs can be co-dominant; no trees; wet soil                                         | 7.3%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Sedge Meadow              |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 6     | Forest                     | Subalpine Poplar Forest          | Common on or near overbank deposits; characterized by \> 20% tree cover and thick mossy floor                                                | 4.6%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine White Spruce Forest     |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Gravelly Poplar Forest  |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Spruce-Poplar Forest    |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+

: caption

## Lichen Mat Thickness and Biomass

We estimated lichen biomass for each plot from mean lichen height using the Moen et al. (2007) regression based on four forage lichen species:

$B=1135.6T$,

where T is mean lichen mat thickness (cm) and B is mean lichen mat biomass (kg/ha). Statistical analyses- R Studio software (RStudio Team, 2015) was used for all analyses. Following the methods recommended by Elzinga et al. (1998), we sequentially sampled percent cover values to test for a stable estimate of the overall population mean and standard deviation. We additionally used two-tailed significance tests to determine the necessary sample size for estimating percent cover for a single population and for detecting differences in percent cover between two time periods.

## Fecal Pellet Analysis

We collected fecal pellets from the range of the Chisana caribou herd in order to quantify what plants the Chisana caribou were feeding on. Collected fecal pellets were analyzed for taxa by XXX lab

## Litter

Added up the number of transects by litter type and divided by the total number of transects.

## Number of plots by ecotype

Why only one plot in Forest? Merkhofer: "We found that Forest ecotypes made for difficult helicopter landing access and subsequently sampled only one site from this ecotype. Future sampling should be targeted to these under-sampled ecotypes."

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Number of plots by ecotype.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

# Display the sampling plots
knitr::kable(sqldf("SELECT Ecotype,Count(Ecotype) as n 
FROM Plots
Group By Ecotype
ORDER BY n DESC"))



```

## Map

A map of the plots is shown below:

```{r, echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Map of sampling plots.",sep="")}
# Increment the figure counter
FigureCounter = FigureCounter + 1

# Map the units in Leaflet
leaflet() %>%
  
  # Set the view and zoom levels
  setView(lng = mean(Plots$Longitude), lat = mean(Plots$Latitude), zoom = 9) %>%
  
  # Add WMS tiles
  addWMSTiles('https://basemap.nationalmap.gov:443/arcgis/services/USGSTopo/MapServer/WmsServer',layers = "0",options = WMSTileOptions(format = "image/png"))  %>%

  # Add the points
  addCircleMarkers(lng = Plots$Longitude, lat = Plots$Latitude, popup = Plots$Plot, color=) %>%
 
  # Label the units 
  addLabelOnlyMarkers(~Longitude,~Latitude, label = ~Plot, data = Plots,  labelOptions = labelOptions(noHide = TRUE))

```

# Caribou Ecotype Preference

I performed a spatial join of the GPS collar data over the major ecotypes to see where caribou were spending their time. I used the 'Join Attributes by Location' tool in QGIS to add the ecotype to each GPS fix. I then summarized the number of pings by ecotype.

# Results

## Vegetation Cover

```{r, echo=FALSE}

# Calculate percent cover from the vegetation dataset for each species over the entire dataset 
# Start by getting the entire list of species
Sql = "SELECT ScientificName

-- Now add in the counts of intercepts by stratum by species (UPPER() ensures that the species codes, which are sometimes inconsistent in case, match)
, (SELECT COUNT(TopCanopy) AS n FROM Dataset_VegData v where UPPER(v.TopCanopy) = UPPER(s.SpeciesCode))  as TopCanopyIntercepts
, (SELECT COUNT(Lower1) AS n FROM Dataset_VegData v where UPPER(v.Lower1) = UPPER(s.SpeciesCode)) as Lower1Intercepts
, (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v where UPPER(v.Lower2) = UPPER(s.SpeciesCode)) as Lower2Intercepts
, (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v where UPPER(v.Lower3) = UPPER(s.SpeciesCode)) as Lower3Intercepts

-- Sum the mid-story strata by adding the Lower1-3 strata intercept counts together
, (SELECT COUNT(Lower1) AS n FROM Dataset_VegData v where UPPER(v.Lower1) = UPPER(s.SpeciesCode))
	  + (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v where UPPER(v.Lower2) = UPPER(s.SpeciesCode))
	  + (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v where UPPER(v.Lower3) = UPPER(s.SpeciesCode))
	as LowerInterceptsCombined
	
-- Count the number of soil surface intercepts for the current species
, (SELECT COUNT(SoilSurface) AS n FROM Dataset_VegData v where UPPER(v.SoilSurface) = UPPER(s.SpeciesCode)) as SoilSurfaceIntercepts

-- Total number of possible intercepts 
,(SELECT Count(*) as n FROM Dataset_VegData) as TotalHitsPossible 

-- TopCanopy Percent Cover: Add up the total number of intercepts for the current species and divide by the total number of hits that were possible
, (SELECT Cast(COUNT(TopCanopy) as Float) AS n FROM Dataset_VegData v where UPPER(v.TopCanopy) = UPPER(s.SpeciesCode)) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_TopCanopy

-- Lower1 Percent Cover: Add up the total number of intercepts for the current species and divide by the total number of hits that were possible
, Cast((SELECT COUNT(Lower1) AS n FROM Dataset_VegData v where UPPER(v.Lower1) = UPPER(s.SpeciesCode)) As Float) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_Lower1

-- Lower2 Percent Cover: Add up the total number of intercepts for the current species and divide by the total number of hits that were possible
, Cast((SELECT COUNT(Lower2) AS n FROM Dataset_VegData v where UPPER(v.Lower2) = UPPER(s.SpeciesCode)) As Float) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_Lower2

-- Lower3 Percent Cover: Add up the total number of intercepts and divide by the total number of hits that were possible
, Cast((SELECT COUNT(Lower3) AS n FROM Dataset_VegData v where UPPER(v.Lower3) = UPPER(s.SpeciesCode)) As Float) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_Lower3

-- Lower intercepts combined cover: Add up all the hits for Lower1-3 and divide by the total number of hits that were possible times 3
-- Cast the numerator from int to float so that the result gets decimal places rather than being an int
, Cast(((SELECT COUNT(Lower1) AS n FROM Dataset_VegData v where UPPER(v.Lower1) = UPPER(s.SpeciesCode)) -- Lower1 total hits
	+ (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v where UPPER(v.Lower2) = UPPER(s.SpeciesCode)) -- Lower2 total hits
	+ (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v where UPPER(v.Lower3) = UPPER(s.SpeciesCode))) As Float) -- Lower3 total hits
	 / ((SELECT Count(*) as n FROM Dataset_VegData) * 3) * 100 -- Total hits possible times 3 for the three strata, Lower1-3
	as PctCover_LowerInterceptsCombined

-- Soil Surface Percent Cover: Add up the total number of intercepts and divide by the total number of hits that were possible
, Cast((SELECT COUNT(SoilSurface) AS n FROM Dataset_VegData v where UPPER(v.SoilSurface) = UPPER(s.SpeciesCode)) As Float) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_SoilSurface

,UPPER(SpeciesCode)
,GrowthHabitSub
FROM SpeciesList s
ORDER BY ScientificName"

# Generate a data frame of cover values by species
CoverData = sqldf(Sql)

# Write the deliverables schedule plots to file
# Filename = paste("CV-10 Percent Cover By Species.csv",sep="")
# WriteDataFrameToFile(CoverData,Filename)

#knitr::kable(CoverData,digits=2)

```

### Foliar cover

\*Unweighted by ecotype area.

Question: Merkhofer states "We estimated the percent cover of major life forms across the entire study area as the average of ecotype means weighted by ecotype area." She did not give a formula. I'm uncertain how to weight means. The tables below give gover as the number of point intercept hits divided by the total number of available tries, unweighted by ecotype area.]

Results:

-   Overall foliar plant cover in the vegetation plots we sampled was dominated by dwarf birch, sedges, *Dryas* and willow, species emblematic of alpine tundra.

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Percent foliar cover by taxa in the range of the Chisana caribou herd having cover greater than 1%.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

# Print the foliar (TopCanopy stratum) cover.
knitr::kable(sqldf("SELECT ScientificName as Taxa,PctCover_TopCanopy as [% cover] 
FROM CoverData 
WHERE GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic')
And PctCover_TopCanopy > 1
AND PctCover_TopCanopy > 0
ORDER BY PctCover_TopCanopy DESC"),digits=0)
```

<!-- ### Mid-story Cover -->

<!-- -   Mid-story percent cover values are very low because of diminishing likelihood of a hit in Lower2 and exponentially diminishing likelihood of a hit on Lower3. We can't just sum Lower1-3 and divide by the number of hit opportunities. LM ignored Lower1-3, probably for this reason? Or should we just use Lower1? -->

<!-- \*Unweighted by ecotype area. -->

<!-- ```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Percent mid-story cover by taxa in the range of the Chisana caribou herd having cover greater than 0.1%.",sep="")} -->

<!-- # Increment the table counter -->

<!-- TableCounter = TableCounter + 1 -->

<!-- # Print the mid-story (Lower1-3 strata) cover. -->

<!-- knitr::kable(sqldf("SELECT ScientificName as Taxa,PctCover_LowerInterceptsCombined as [% cover]  -->

<!-- FROM CoverData  -->

<!-- WHERE GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic') -->

<!-- AND PctCover_LowerInterceptsCombined > 0.1 -->

<!-- ORDER BY PctCover_LowerInterceptsCombined DESC")) -->

<!-- ``` -->

### Basal Cover

\*Unweighted by ecotype area.

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Percent basal cover by taxa in the range of the Chisana caribou herd having cover greater than 0.1%.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

# Print the basal (SoilSurface stratum) cover.
knitr::kable(sqldf("SELECT ScientificName as Taxa,PctCover_SoilSurface as [% cover] 
FROM CoverData 
WHERE 
-- GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic')
GrowthHabitSub NOT IN ('Abiotic')
AND PctCover_SoilSurface > 0.1
ORDER BY PctCover_SoilSurface DESC"),digits=0)

```

## Lichen Layer Thickness and Biomass

NOTES on lichen biomass: I'm using LM's conversion of lichen height to biomas "We estimated lichen biomass for each plot from mean lichen height using the Moen et al. (2007) regression based on four forage lichen species as B=1135.6T where T is mean lichen mat thickness (cm) and B is mean lichen mat biomass (kg/ha). ,1135.6 \* AVG(IFNULL(v.LichenHeight,0)) as [Estimated lichen biomass (kg/ha)" without really knowing much about that methodology.

Also Moen et al. considered 4 leafy lichens. LM and JP did not distinguish any species of lichens in their lichen height measument at each point intercept ("We calculated the mean lichen height of each plot as the average of all heights, including zero heights where no lichen was present").

```{r, echo=FALSE}

# Get the lichen thickness and biomass data
Sql="SELECT Ecotype

-- NOTE: I used IFNULL() to convert NULL values to zero because data collectors left lichen height field blank where no lichens were observed on transect points.
-- LM's methods section states that lichen height was measured at each point intercept, therefore NULLs should, in fact, be zeros.
, AVG(IFNULL(v.LichenHeight,0)) AS [Mean lichen thickness (cm)]
, MIN(IFNULL(v.LichenHeight,0)) AS Min
, MAX(IFNULL(v.LichenHeight,0)) AS Max
, STDEV(IFNULL(v.LichenHeight,0)) AS SD

-- We estimated lichen biomass for each plot from mean lichen height using the Moen et al. (2007) regression based on four forage lichen species as B=1135.6T where T is mean lichen mat thickness (cm) and B is mean lichen mat biomass (kg/ha).
,1135.6 * AVG(IFNULL(v.LichenHeight,0)) as [Estimated lichen biomass (kg/ha)] 

-- Biomass estimate lower by one standard deviation, the case statement returns zero in cases where the mean lichen thickness minus one standard deviation is zero in which case biomass should be zero
,Case 
  When AVG(IFNULL(v.LichenHeight,0)) - STDEV(IFNULL(v.LichenHeight,0)) < 0 Then 0 
  Else AVG(IFNULL(v.LichenHeight,0)) - STDEV(IFNULL(v.LichenHeight,0)) * 1135.6 
 End As [Biomass lower estimate] 

-- Biomass estimate upper by one standard deviation
,1135.6 * (AVG(IFNULL(v.LichenHeight,0)) + STDEV(IFNULL(v.LichenHeight,0))) as [Biomass upper estimate] 

, COUNT(*) AS n
, COUNT(DISTINCT Plot) as [Number of plots]
, COUNT(Line) as [Number of transects]
,EcotypeID
FROM Dataset_VegData v 
GROUP BY Ecotype,EcotypeID
ORDER BY [Mean lichen thickness (cm)]  DESC"

Biomass = sqldf(Sql)

```

```{r}
# Start by calculating mean lichen heights by plot
MeanLichenHeightByPlot = Dataset_VegData %>% select(Ecotype,Plot,Line,PointLoc,LichenHeight) %>% 
  filter(is.na(LichenHeight) == FALSE) %>% 
  group_by(Plot) %>% 
  summarize(
    Plots=n_distinct(Plot)
    ,Transects=n_distinct(Line)
    ,NonNullLichenHeights=n()
    ,`Mean lichen thickness (cm)`=mean(LichenHeight)
    ,MeanHt=mean(LichenHeight) # This column duplicates the one above but dplyr wouldn't calculate an SD on a column named `Mean lichen thickness (cm)` so I calculated it below on MeanHt instead
    ,SD=sd(LichenHeight)
  ) %>%
  arrange(Plot)

# Calculate estimated biomass and add it to the MeanLichenHeightByPlot table
MeanLichenHeightByPlot$`Estimated lichen biomass (kg/ha)` = MeanLichenHeightByPlot$MeanHt * 1135.6 # Moen et al. (2007)

# Join the results to the Plots table in order by add the Ecotype back in so we can calculate statistics by ecotype
MeanLichenHeightByPlot = inner_join(MeanLichenHeightByPlot,Plots,by='Plot') %>% select(Ecotype,Plot,Plots,Transects,NonNullLichenHeights,`Mean lichen thickness (cm)`,SD,MeanHt)

# Next calculate mean lichen height by ecotype (mean of mean lichen height by plot)
MeanLichenHeightByEcotype = MeanLichenHeightByPlot %>% group_by(Ecotype) %>% 
  #filter(Ecotype == 'Alpine Dwarf Shrub/Barrens') %>%
  summarise(
    Plots=sum(Plots)
    ,Transects=sum(Transects)
    ,`Mean lichen thickness (cm)`= mean(`Mean lichen thickness (cm)`)
    ,SD=sd(MeanHt,na.rm=TRUE) # Note: SD is calculated on MeanHt instead of `Mean lichen thickness (cm)` because dplyr wouldn't give me an SD on that column name so I had to create a duplicate column
    ,`Estimated biomass (kg/ha)`=mean(`Estimated lichen biomass (kg/ha)`)
    ,n=sum(NonNullLichenHeights)
  )

```

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Mean lichen thickness (cm) by ecotype.  Note that only one plot was sampled in the Forest ecotype..",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

# Output the lichen thickness by ecotype
knitr::kable(MeanLichenHeightByEcotype, digits = 2)

# Output the lichen thickness by plot
#knitr::kable(MeanLichenHeightByPlot, digits = 2)

```

```{r, echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Mean lichen thickness (cm) by ecotype. Error bars represent one standard deviation. Note that only one plot was sampled in the Forest ecotype.",sep="")}

ggplot(MeanLichenHeightByEcotype) +
  # Mean lichen height column chart
  geom_col(aes(x=Ecotype,y=`Mean lichen thickness (cm)`),fill='lightgray',color='darkgray') +
  
  # Error bars as standard deviation
  geom_errorbar(aes(x=Ecotype,ymin=`Mean lichen thickness (cm)` - SD,ymax=`Mean lichen thickness (cm)` + SD),width=0.2) +
  geom_text(aes(x=Ecotype,y=`Mean lichen thickness (cm)`,label=round(`Mean lichen thickness (cm)`,digits=2)) ) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("Mean lichen thickness by ecotype")

#Increment the figure counter
FigureCounter=FigureCounter+1

```

```{r, echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Mean lichen thickness (cm) by plot Error bars represent one standard deviation. Note that only one plot was sampled in the Forest ecotype.",sep="")}

ggplot(MeanLichenHeightByPlot) +
  # Mean lichen height column chart
  geom_col(aes(x=Plot,y=`Mean lichen thickness (cm)`,fill=Ecotype)) +
  
  # Error bars as standard deviation
  geom_errorbar(aes(x=Plot,ymin=ifelse(`Mean lichen thickness (cm)` - SD < 0,0,`Mean lichen thickness (cm)` - SD),ymax=`Mean lichen thickness (cm)` + SD),width=0.5,color='gray') +
  geom_text(aes(x=Plot,y=`Mean lichen thickness (cm)`,label=round(`Mean lichen thickness (cm)`,digits=2)) ) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))  +
  ggtitle("Mean lichen thickness by plot")

#Increment the figure counter
FigureCounter=FigureCounter+1
```

```{r, echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Mean lichen biomass (kg/ha) by ecotype (Moen et al., 2007) Error bars represent one standard deviation. Note that only one plot was sampled in the Forest ecotype.",sep="")}

ggplot(MeanLichenHeightByEcotype) +
  # Mean lichen height column chart
  geom_col(aes(x=Ecotype,y=`Estimated biomass (kg/ha)`),fill='lightgray',color='darkgray') +
  
  # Error bars as standard deviation
  #geom_errorbar(aes(x=Ecotype,ymin=`Estimated biomass (kg/ha)` - SD,ymax=`Estimated biomass (kg/ha)` + SD),width=0.2) +
  geom_text(aes(x=Ecotype,y=`Estimated biomass (kg/ha)`,label=round(`Estimated biomass (kg/ha)`,digits=2)) ) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("Estimated lichen biomass (kg/ha) by ecotype")

#Increment the figure counter
FigureCounter=FigureCounter+1

```

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Mean lichen thickness (cm) and estimated biomass (kg/ha) by ecotype in the range of the Chisana caribou herd. Biomass is estimated as the mean lichen thickness (cm) multiplied by 1135.6 (Moen et al. (2007). Upper and lower biomass estimates are calculated by adding or subtracting one standard deviation from the mean lichen thickness and multiplying by 1135.6, respectively. Note that only one plot was sampled in the Forest ecotype.",sep="")}

# Increment the table counter
TableCounter = TableCounter + 1

# Output the lichen thickness and biomass stats
Sql = "SELECT Ecotype
,[Estimated lichen biomass (kg/ha)]
,[Biomass lower estimate] As [Biomass lower estimate (kg/ha)]
,[Biomass upper estimate]  As [Biomass upper estimate (kg/ha)]
,n,[Number of plots]
FROM Biomass ORDER BY [Mean lichen thickness (cm)] DESC"
Sql = "SELECT 'Reconfigure this'"
knitr::kable(sqldf(Sql), digits = 2)

```

```{r, echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Mean lichen thickness (cm) by ecotype.",sep="")}

ggplot(Biomass) +
  geom_col(aes(x=Ecotype,y=`Estimated lichen biomass (kg/ha)`),fill='lightgray',color='darkgray') +
  geom_errorbar(aes(x=Ecotype,ymin=`Biomass lower estimate`,ymax=`Biomass upper estimate`)) +
  geom_text(aes(x=Ecotype,y=`Estimated lichen biomass (kg/ha)`,label= round(`Estimated lichen biomass (kg/ha)`,digits=2))) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) 

```

## Litter

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Litter dominance (count of transects by litter type divided by total number of transects.",sep="")}

# Increment the table counter
TableCounter = TableCounter + 1

# Get a list of distinct LitterTypes to use in queries that follow
LitterTypes = sqldf("SELECT DISTINCT NTransectLitterType As LitterType FROM Plots 
UNION 
SELECT DISTINCT SETransectLitterType FROM Plots
UNION 
SELECT DISTINCT SWTransectLitterType FROM Plots
")


Sql = "SELECT IFNULL(LitterType,'None') As  [Litter type]

-- Uncomment the columns below to see the counts of transects by litter type
,(SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.NTransectLitterType,'None') = IFNULL(d.LitterType,'None')) As NTransects
,(SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SWTransectLitterType,'None') = IFNULL(d.LitterType,'None')) As SWTransects
,(SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SETransectLitterType,'None') = IFNULL(d.LitterType,'None')) As SETransects

, (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.NTransectLitterType,'None') = IFNULL(d.LitterType,'None')) 
+ (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SWTransectLitterType,'None') = IFNULL(d.LitterType,'None'))
+ (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SETransectLitterType,'None') = IFNULL(d.LitterType,'None')) As SumOfTransects

,(SELECT Count(*) FROM Plots WHERE EstablishDate IS NOT NULL) * 3 As TotalNumberOfTransects

,CAST((
	 (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.NTransectLitterType,'None') = IFNULL(d.LitterType,'None')) 
	+ (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SWTransectLitterType,'None') = IFNULL(d.LitterType,'None'))
	+ (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SETransectLitterType,'None') = IFNULL(d.LitterType,'None')))
	As Float)
	/ (SELECT Count(*)* 3 FROM Plots WHERE EstablishDate IS NOT NULL) * 100
	As [% of transects]

FROM LitterTypes d
ORDER BY [% of transects] DESC,LitterType
"

# Get the litter type data into a data frame
LitterType = sqldf(Sql)

# Print out the summary table
knitr::kable(sqldf("SELECT [Litter type],SumOfTransects as [Number of transects],[% of transects] FROM LitterType ORDER BY [% of transects] DESC"),digits=1)

# Get the total number of transects sampled into a parameter to us in the text
TotalTransects = LitterType[1,"TotalNumberOfTransects"]

```

## Caribou Ecotype Preference

```{r, echo=FALSE}
# Read in the ecotype preference dataset
# This was generated by loading the chisana caribou gps collar data into GIS over the ecotypes polygons and then adding the ecotype that the point overlapped as a column and exporting as a CSV

# This is how I processed the GPS data, the lines below won't be needed as the data file is processed and can be imported.
# EcoPref = read.csv("J:/Monitoring/Caribou/WRST/Projects/Chisana Caribou Habitat Assessment/Data/ChisanaGPSPointsByEcotype.csv")
# 
# # QC
# EcoPref$Date = as.Date(EcoPref$Date) # Make the dates actual dates
# 
# # The Season column came out of GIS screwed up, fix it
# # Winter is October through March, otherwise summer
# EcoPref$Season = ifelse(EcoPref$Month <= 3 | EcoPref$Month >= 10,'Summer','Winter') 
# 
# # Extract only the needed columns
# EcoPref = sqldf("SELECT AnimalId as Caribou,[Date],Lat_WGS84 as Lat,Lon_WGS84 as Lon,Month,Day,Season,Ecotype_2 as Ecotype FROM EcoPref ORDER BY AnimalId,Date")
# 
# # Join the lichen biomass data by ecotype
# EcoPref = merge(EcoPref,Biomass,by="Ecotype")
# EcoPref = sqldf("SELECT Caribou,Date,Ecotype,Lat,Lon,strftime('%Y',Date) As Year,Month,Day FROM EcoPref ORDER BY Caribou,Date")

# Write the GPS data to file
# Filename = paste("CV-10 Caribou Ecotype Preference Spatial Data SENSITIVE ",Sys.Date(),".csv",sep="")
# WriteDataFrameToFile(EcoPref,Filename)

# Read in the caribou ecotype preference dataset

#Read in the caribou ecotype preference dataset
EcoPref = read.csv(paste(DeliverablesDirectory,"CV-10 Caribou Ecotype Preference Spatial Data SENSITIVE.csv",sep=""),header=TRUE)
```

### Ecotype preference

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Ecotype preference of Chisana caribou as determined from the number of GPS collar fixes by ecotype.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

Sql = "SELECT Ecotype
,Count(*) as [GPS Fixes] 
,(SELECT Count(*) FROM EcoPref WHERE Ecotype IS NOT NULL and NOT Ecotype = '') as TotalFixes
,Cast(Count(*) As Float) / (SELECT Count(*) FROM EcoPref WHERE Ecotype IS NOT NULL and NOT Ecotype = '') * 100 as [Percent of fixes]
FROM EcoPref
WHERE Ecotype IS NOT NULL and NOT Ecotype = ''
GROUP BY Ecotype 
ORDER By Count(*) DESC"
PercentOfFixesByEcotype = sqldf(Sql)
knitr::kable(sqldf("SELECT Ecotype,ConCat(Cast([Percent of fixes] as Int),'%') as [Percent of GPS fixes]  FROM PercentOfFixesByEcotype ORDER BY [Percent of fixes] DESC"),digits=2)

# Get the total number of GPS fixes into a parameter that can be used in the text
TotalGPSFixes = PercentOfFixesByEcotype[1,'TotalFixes']

```

Total GPS fixes = `r TotalGPSFixes`

### Ecotype Preference By Month

```{r, echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Chisana caribou ecotype preference by month as determined from GPS collar data.",sep="")}
# By Month
Sql = "SELECT Month, Ecotype,Count(*) as [GPS Fixes]
FROM EcoPref
WHERE Ecotype IS NOT NULL and NOT Ecotype = ''
GROUP BY Month,Ecotype 
ORDER By Month, Count(*) DESC"
EcoPrefByMonth = sqldf(Sql)


ggplot(EcoPrefByMonth) +
  geom_col(aes(x=Month,y=`GPS Fixes`,fill=Ecotype),position="fill") +
  ggtitle("Chisana caribou ecotype preference by month") +
  theme_minimal() +
  # Make X axis labels vertical
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  scale_x_continuous(breaks = seq(1, 12, by = 1)) 

```

## Fecal Pellet Analysis

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Fecal pellet composition for plant categories greater than one percent.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

Sql = "SELECT Plant,Avg(PctComposition) as Mean,Count(*) as n 
FROM PelletData 
GROUP BY Plant 
--HAVING Avg(PctComposition) > 1
ORDER BY Avg(PctComposition) DESC"
knitr::kable(sqldf(Sql))
```

# Discussion

To be written

# Appendix A: Sampling Plots

## List Of Plots

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Sampling plots.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

knitr::kable(sqldf("SELECT Plot,Ecotype,EstablishDate,Elev_m as [Elevation (m)],Latitude,Longitude FROM Plots ORDER BY Plot"),caption='Table ?. Sampling plots.')

```

## Elevational Profiles

```{r, echo=FALSE,fig.cap=paste("Table ",TableCounter,". Sampling plots elevation profile by ecotype. Error bars represent the minimum and maximum plot elevation for each ecotype.",sep="")}

# Increment the table counter
TableCounter = TableCounter + 1

ggplot(sqldf("SELECT Ecotype,Avg(Elev_m) as [Mean elevation (m)],Min(Elev_m) as [Min. elevation (m)],Max(Elev_m) as [Max. elevation (m)] FROM Plots Group By Ecotype")) +
  geom_point(aes(x=reorder(Ecotype,`Mean elevation (m)`),y=`Mean elevation (m)`)) +
  geom_errorbar(aes(x=reorder(Ecotype,`Mean elevation (m)`),ymin=`Min. elevation (m)`,ymax=`Max. elevation (m)`)) +
  ggtitle(paste("Ecotypes elevation profile ",sep="")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ylab("Elevation (m)") +
  xlab("Ecotype")

```

```{r, echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Sampling plots elevation profile by plot.",sep="")}

ggplot(Plots) +
  geom_point(aes(x=reorder(Plot,Elev_m),y=Elev_m,shape=Ecotype)) +
  ggtitle(paste("Sampling plots elevation profile ",sep="")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ylab("Elevation (m)") +
  xlab("Plot")

```

# Appendix B: Vegetation Summary By Ecotype

```{r, echo=FALSE, results='asis'}

# This code block generates a table of vegetation point intercept counts by plant species and ecotype and generates percent cover for each strata (TopCanpoy, Lower1-3, SoilSurface)
  
# Build the query
# Start by building a set of all ecotypes by all species
Sql = "SELECT e.Ecotype, s.ScientificName,s.GrowthHabitSub

--, (SELECT Count(*) FROM Dataset_VegData v WHERE v.Ecotype=e.Ecotype And  TRIM(v.Lower1)='')  as Lower1NullIntercepts -- Note: IS NULL doesn't seem to work as a filter on the Dataset_Veg data frame. The NULLs seem to have been converted to blanks when the data were read.csved  in from file

-- Now add in the counts of intercepts by stratum by species [UPPER() ensures that the species codes, which are sometimes inconsistent in case, match]
, (SELECT COUNT(TopCanopy) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.TopCanopy) = UPPER(s.SpeciesCode) And UPPER(v.TopCanopy) = UPPER(s.SpeciesCode))  as TopCanopyIntercepts

, (SELECT COUNT(Lower1) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower1) = UPPER(s.SpeciesCode)) as Lower1Intercepts

, (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower2) = UPPER(s.SpeciesCode)) as Lower2Intercepts
, (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower3) = UPPER(s.SpeciesCode)) as Lower3Intercepts

-- Sum the mid-story strata by adding the Lower1-3 strata intercept counts together
-- , (SELECT COUNT(Lower1) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower1) = UPPER(s.SpeciesCode))
-- 	  + (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower2) = UPPER(s.SpeciesCode))
-- 	  + (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower3) = UPPER(s.SpeciesCode))
-- 	as LowerInterceptsCombined

-- Count the number of soil surface intercepts for the current species
, (SELECT COUNT(SoilSurface) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.SoilSurface) = UPPER(s.SpeciesCode)) as SoilSurfaceIntercepts

-- Calculate foliar percent cover for each ecotype by dividing the intercepts by species by the number of possible intercepts
, CAST((SELECT COUNT(TopCanopy) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.TopCanopy) = UPPER(s.SpeciesCode)) As Float) 
  / (SELECT Count(*) as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) * 100
as PctCover_TopCanopy

-- Calculate Lower1 percent cover for each ecotype by dividing the intercepts by species by the number of possible intercepts
, CAST((SELECT COUNT(Lower1) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower1) = UPPER(s.SpeciesCode)) As Float) 
  / (SELECT Count(*) as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) * 100
as PctCover_Lower1

-- Calculate soil surface percent cover for each ecotype by dividing the intercepts by species by the number of possible intercepts
, CAST((SELECT COUNT(SoilSurface) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.SoilSurface) = UPPER(s.SpeciesCode)) As Float) 
  / (SELECT Count(*) as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) * 100
as PctCover_SoilSurface

-- Calculate mid-story (Lower1-3) percent cover for each ecotype by dividing the intercepts by species by the number of possible intercepts
-- NOTE: This doesn't work because Lower2 and 3 are essentially 'blocked' by Lower1, diminishing the odds of a 'hit'. The result calculated below gave misleading very lowe percent cover
--, CAST((SELECT COUNT(Lower1) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower1) = UPPER(s.SpeciesCode))
--	  + (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower2) = UPPER(s.SpeciesCode))
--	  + (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower3) = UPPER(s.SpeciesCode)) As Float)
--	  / (SELECT Count(*) * 3 as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) -- Multiply the denominator by 3 because there are three mid-story levels
--	   * 100 as PctCover_LowerInterceptsCombined

-- Total number of possible intercepts for each ecotype
,(SELECT Count(*) as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) as TotalHitsPossible

FROM SpeciesList s
CROSS JOIN Ecotypes e
ORDER BY e.Ecotype, s.ScientificName"

# Execute the query into a data frame
CoverDataByEcotype = sqldf(Sql)
#write.table(CoverDataByEcotype,file="C:/temp/zCoverByEcotype.csv",quote=TRUE,row.names = FALSE,col.names=TRUE,sep=",")



```

```{r, echo=FALSE, results='asis'}

# Function to dump out a report section characterizing each ecotype
GetEcotypeSection = function(Ecotype){

    # Header and text
  cat("# ",Ecotype,"  \n\n")
  cat("  \n\n")
  
  
  # Ecotype description
  cat("## Distinguishing features and cover.  \n\n")
  EcotypeDescription = sqldf("SELECT Ecotype,DistinguishingFeatures as [Distinguishing features],Cover as [Percent of Chisana range] FROM Ecotypes WHERE Ecotype='Forest'")
  cat(EcotypeDescription$`Distinguishing features`," \n\n")
  cat("The",Ecotype,"ecotype covers approximately",EcotypeDescription[1,3],"% of the Chisana caribou herd range. \n\n")
  cat("  \n\n")
  
  
  
  
  # Plots in the ecotype and their sampling dates and attributes
  cat("## Sampling Plots.  \n\n")
  
  PlotSummary = sqldf(paste("SELECT DISTINCT Dataset_VegData.Plot,Plots.Elev_m as [Elevation (m)],Plots.EstablishDate as [Sampling Date]
    FROM Dataset_VegData 
    JOIN Plots on Plots.Plot = Dataset_VegData.Plot 
    WHERE Dataset_VegData.Ecotype = '",Ecotype,"' 
    ORDER BY Dataset_VegData.Plot",sep=""))
  # Add in a total row
  cat("  \n\n")
  cat("Table ",TableCounter,". Plots And sampling dates in the ",Ecotype," ecotype.  \n\n")
  print(knitr::kable(PlotSummary,digits=1))
  cat("  \n\n")
  cat("Mean elevation (m) = ",round(mean(PlotSummary$`Elevation (m)`),1),", number of plots = ",nrow(PlotSummary),"  \n\n")
  TableCounter = TableCounter + 1
  

  
  
  
  
  
  # Dump out the foliar cover
  cat("## Foliar Cover  \n\n")
  cat("Table ",TableCounter,". Plots And sampling dates in the ",Ecotype," ecotype.  \n\n")
  Sql = paste("SELECT ScientificName,TopCanopyIntercepts as Hits,TotalHitsPossible as Opportunities,CAST(PctCover_TopCanopy As Float) As [% cover] 
      FROM CoverDataByEcotype 
      WHERE Ecotype='",Ecotype,"' And [% cover] > 1 
      ORDER BY [% cover] DESC",sep="")
  Cover = sqldf(Sql)
  
  # Plot the foliar plant cover
  cat("  \n\n")
  print(
    ggplot(Cover) +
      geom_col(aes(x=reorder(ScientificName,-`% cover`),y=`% cover`)) +
      ggtitle(paste("Foliar Cover: ",Ecotype," Ecotype",sep="")) +
      theme_minimal() +
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
      xlab("Taxa") +
      ylab("% cover")
  )
  cat(" Figure ",FigureCounter,". Foliar percent cover in the ",Ecotype," ecotype having percent cover greater than 1%. X-axis taxa may include abiotic strata such as soil, litter or rock where no plant species were intercepted.  \n\n")
  cat("  \n\n")
  FigureCounter = FigureCounter + 1
  
  # Foliar plant cover summary table
  Cover[nrow(Cover) + 1,] = c("TOTAL",sum(Cover$Hits),'',sum(Cover$`% cover`))
  cat("Table ",TableCounter,". Foliar cover in the ",Ecotype," ecotype.  \n\n")
  print(knitr::kable(Cover,digits=1))
  cat("  \n\n")
  TableCounter = TableCounter + 1
  
  
  
  
  
  # Dump out the midstory cover. NOTE: The table below only considers Lower1 intercepts - ignores Lower2 and 3.
  cat("## Mid-Story Cover  \n\n")
  cat("  \n\n")
  Sql = paste("SELECT ScientificName,Lower1Intercepts as Hits,TotalHitsPossible as Opportunities,CAST(PctCover_Lower1 As Float) As [% cover]
    FROM CoverDataByEcotype 
    WHERE Ecotype='",Ecotype,"' And [% cover] > 1 
    ORDER BY [% cover] DESC",sep="")
  Cover = sqldf(Sql)
  
    # Plot the soil surface cover
  cat("  \n\n")
  print(
    ggplot(Cover) +
      geom_col(aes(x=reorder(ScientificName,-`% cover`),y=`% cover`)) +
      ggtitle(paste("Mid-story cover: ",Ecotype,sep="")) +
      theme_minimal() +
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
      xlab("Taxa") +
      ylab("% cover")
  )
    cat(" Figure ",FigureCounter,". Mid-story percent cover in the ",Ecotype," ecotype having percent cover greater than 1%. X-axis taxa may include abiotic strata such as soil, litter or rock where no plant species were intercepted.  \n\n")
    cat("  \n\n")
    FigureCounter = FigureCounter + 1
  
  # Mid-story cover summary table
  Cover[nrow(Cover) + 1,] = c("TOTAL",sum(Cover$Hits),'',sum(Cover$`% cover`))
  cat("Table ",TableCounter,". Midstory cover in the ",Ecotype," ecotype.  \n\n")
  print(knitr::kable(Cover,digits=1))
  cat("  \n\n")
  TableCounter = TableCounter + 1
  
  
  
  
  
  # Dump out the soil surface cover. NOTE: The table below only considers Lower1 intercepts - ignores Lower2 and 3.
  cat("## Soil Surface Cover  \n\n")
  cat("  \n\n")
  Sql = paste("SELECT ScientificName,SoilSurfaceIntercepts as Hits,TotalHitsPossible as Opportunities,CAST(PctCover_SoilSurface As Float) As [% cover] 
    FROM CoverDataByEcotype 
    WHERE Ecotype='",Ecotype,"' And [% cover] > 0 
    ORDER BY [% cover] DESC",sep="")
  Cover = sqldf(Sql)
  
  # Plot the soil surface cover
  cat("  \n\n")
  print(
    ggplot(Cover) +
      geom_col(aes(x=reorder(ScientificName,-`% cover`),y=`% cover`)) +
      ggtitle(paste("Soil surface cover: ",Ecotype,sep="")) +
      xlab("Point intercept") +
      theme_minimal() +
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
      xlab("Taxa") +
      ylab("% cover")
  )
      cat(" Figure B-3. Soil surface percent cover in the ",Ecotype," ecotype having percent cover greater than 1%. X-axis taxa may include abiotic strata such as soil, litter or rock where no plant species were intercepted.  \n\n")
    cat("  \n\n")
    FigureCounter = FigureCounter + 1
  
  # Add in a total row and output
  Cover[nrow(Cover) + 1,] = c("TOTAL",sum(Cover$Hits),'',sum(Cover$`% cover`))
  cat("Table ",TableCounter,". Soil surface cover in the ",Ecotype," ecotype.  \n\n")
  print(knitr::kable(Cover,digits=1))
  cat("  \n\n")
  TableCounter = TableCounter + 1

}


# Loop through the ecotypes and generate a report section showing the vegetation composition, foliar, midstory and soil surface, etc.
Samples = sqldf("SELECT Ecotype FROM Ecotypes ORDER BY ECotype")
for(i in 1:nrow(Samples)) {       
  Ecotype = Ecotypes$Ecotype[i]
  GetEcotypeSection(Ecotype)
}

# GetEcotypeSection('Alpine Meadow')

```

# Appendix B: Fecal Pellet Results By Sample

```{r, echo=FALSE, results='asis'}
# Function to dump out a report section showing pellet composition
GetPelletCompositionSummary = function(Sample){
  
  # Header and text
  cat("## Fecal Pellet Sample ",Sample,"  \n\n")
  cat("  \n\n")
  cat("Fecal pellet composition summary:  \n\n")
  cat("  \n\n")
  
  # Get the percent composition of the pellet
  Sql = paste("SELECT Plant,Form,  PctComposition AS [Mean % composition]
  FROM PelletData
  WHERE Sample='",Sample,"' And PctComposition > 0
  ORDER BY Sample, PctComposition DESC",sep="")
  
  # Dump out the composition table
  cat("Table ",TableCounter,". Fecal pellect composition, ",Sample,"  \n\n")
  print(knitr::kable(sqldf(Sql)),digits=1)
  cat("  \n\n")
}

```

```{r, echo=FALSE,results='asis'}
# Loop through the Sample IDs and push out a summary to the report for each
Samples = sqldf("SELECT DISTINCT Sample FROM PelletData WHERE Sample IS NOT NULL ORDER BY Sample")
for(i in 1:nrow(Samples)) {       
  Sample = Samples$Sample[i]
  GetPelletCompositionSummary(Sample)
}

```

# Appendix ?: Litter Type Summary

```{r, echo=FALSE, results='asis',tab.cap=paste("Table ",TableCounter,"Litter composition by transect.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

knitr::kable(LitterType,digits=1)

```

# References

Arseneault, D., Villeneuve, N., Boismenu, C., Leblanc, Y., & Deshaye, J. (1997). Estimating lichen biomass and caribou grazing on the wintering grounds of northern Quebec: An application of fire history and Landsat data. *Journal of Applied Ecology*, 65-78.

Boertje, R. D. (1984). Seasonal diets of the Denali caribou herd, Alaska. *Arctic*, 161-165.

Clarke, H., and M. Waterreus. (2012). Chisana caribou range lichen assessment, September, 2011. Yukon Fish and Wildlife Branch Report SR-12-01. Whitehorse, Yukon, Canada.

Collins, W. B., Dale, B. W., Adams, L. G., Mcelwain, D. E., & Joly, K. (2011). Fire, grazing history, lichen abundance, and winter distribution of caribou in Alaska's taiga. *The Journal of Wildlife Management*, *75*(2), 369-377.

Elzinga, C. L., Salzer, D. W., & Willoughby, J. W. (1998). Measuring & Monitoring Plant Populations. U.S. Bureau of Land Management Papers. Paper 17.

Farnell, R., & Gardner, C. (2002). Chisana caribou herd—2002. *Yukon Department of Environment, Whitehorse, Yukon, Canada*.

Fischer, L. A. (2002). Late winter resource selection and the potential for competition between wood bison and woodland caribou in the Yukon. Doctoral dissertation. The University of Calgary, Alberta.

Florkiewicz, R. F., Flynn, N., MacLean, N., Francis, S. R., Adamczewski, J. Z., & Loewen, V. (2004). *Little Rancheria Caribou in the Yukon: Evaluation of winter habitat quality and habitat use*. Department of Environment Report TR-03-03. Yukon Environment, Yukon.

Herrick, J. E., Van Zee, J. W., Havstad, K. M., Burkett, L. M., & Whitford, W. G. (2005). *Monitoring manual for grassland, shrubland and savanna ecosystems.* USDA-ARS Jornada Experimental.  Las Cruces, New Mexico

Joly, K., Cole, M. J., & Jandt, R. R. (2007). Diets of overwintering caribou, Rangifer tarandus, track decadal changes in Arctic tundra vegetation. *The Canadian Field-Naturalist*, *121*(4), 379-383.

Joly, K., Stuart Chapin III, F., & Klein, D. R. (2010). Winter habitat selection by caribou in relation to lichen abundance, wildfires, grazing, and landscape characteristics in northwest Alaska. *Ecoscience*, *17*(3), 321-333.

Johnson, H. L. (1994). Range Inventory and Monitoring following caribou reintroduction to the Nushagak Peninsula: A progress report of the Nushagak caribou vegetation study on the Togiak National Wildlife Refuge. US Fish and Wildlife Service progress report. Togiak National Wildlife Refuge, Dillingham. 144 pp.

Jorgenson, M. T., J. E. Roth, P. F. Loomis, E. R. Pullman, T. C. Cater, M. S. Duffy, W. A. Davis, and M. J. Macander. (2008). An ecological survey for landcover mapping of Wrangell-St. Elias National Park and Preserve. Natural Resource Technical Report NPS/WRST/NRTR—2008/094. National Park Service, Fort Collins, Colorado.

Moen, J., Danell, Ö., & Holt, R. (2009). Non-destructive estimation of lichen biomass. *Rangifer*, *27*(1).

Oosenbrug, S. M. (1976). *Range relationships and population dynamics of the Burwash Uplands caribou herd, Yukon Territory*. University of Waterloo, Department of Biology.

Oosenbrug, S. M., & Theberge, J. B. (1980). Altitudinal movements and summer habitat preferences of woodland caribou in the Kluane Ranges, Yukon Territory. *Arctic*, 59-72.

Post, E., & Klein, D. R. (1999). Caribou calf production and seasonal range quality during a population decline. *The Journal of Wildlife Management*, 335-345.

Swanson, J. D., & Barker, M. H. W. (1992). Assessment of Alaska reindeer populations and range conditions. *Rangifer*, *12*(1), 33-43.

Valkenburg, P. (1996). Population decline in the Delta caribou herd with reference to other Alaskan herds. *Rangifer*, *16*(4), 53-62.
