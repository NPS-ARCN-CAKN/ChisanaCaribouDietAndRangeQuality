---
title: ""
author: ""
date: ""
output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float: true
---

```{r,label="Setup", include=FALSE, echo=FALSE}

# Global NA to blank
options(knitr.kable.NA = '')
knitr::opts_chunk$set(echo = FALSE)

# Libraries
library(sqldf)
library(tidyverse)
library(odbc)
library(leaflet)
library(ggspatial)
library(sf)
library(corrplot)
library(psych)
library(reshape2)
library(terra)

# Paths to CAKN drive data and Data Store Project Reference
# J:\Monitoring\Caribou\WRST\Projects\Chisana Caribou Habitat Assessment
# https://irma.nps.gov/DataStore/Reference/Profile/2306144

# Directory where project deliverables are stored (authoritative copies will eventually go in Data Store)
DeliverablesDirectory = "J:/Monitoring/Caribou/WRST/Projects/Chisana Caribou Habitat Assessment/Data/Deliverables/"

# Initiate table and figure counters
TableCounter = 2
# Set the figure counter (Figs 1-4 appear in the introductory material. First R generated figure is 5, so start at 5)
FigureCounter = 5

```

```{r,label="Pull data from the database and write it to CSV files for archival", echo=FALSE,include=FALSE}

# This code block is not used analytically but rather to get the the data from the database and written to files that can be archived and made available in Data Store. I want the analysis in this report to come from files rather than the database so that the code can easily be reproduced by anybody using files in Data Store rather than the database. The code in this chunk will be commented out entirely once the files are written and is only included to show how the data files were generated.

# Database connection 
connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna", Database = "ChisanaVegetation")


# Function to Write a data frame to a file in the deliverables directory. This will be used as data is pulled from the database and written to files for archival in Data Store
WriteDataFrameToFile = function(DataFrame,Filename){
  ExportFile = paste(DeliverablesDirectory,Filename,sep="")
  print(paste("Writing ",ExportFile,"\n",sep=""))
  print("WARNING: Writing is temporarily disabled by a comment")
  #write.table(DataFrame,file=ExportFile,quote=TRUE,sep=",",na="",row.names = FALSE, col.names = TRUE)
  #print(paste("Wrote ",ExportFile,"\n",sep=""))
}


# Write the vegetation dataset to file
Sql = "SELECT * FROM [ChisanaVegetation].[dbo].[Dataset_VegData]"
Dataset_VegData = dbGetQuery(connection,Sql)

#Write the vegetation data to file
Dataset_VegDataFilename = paste("CV-10 Chisana Range Vegetation Dataset Ver. ",Sys.Date(),".csv",sep="")
#WriteDataFrameToFile(Dataset_VegData,Dataset_VegDataFilename)
# 
# # Get metadata for the dataset above
# Metadata = dbGetQuery(connection,"SELECT [Column],[Definition] FROM Dataset_VegData_Metadata")
# Dataset_VegDataMetadataFilename = paste(Dataset_VegDataFilename," Column Descriptions.csv",sep="")
# WriteDataFrameToFile(Metadata,Dataset_VegDataMetadataFilename)



# Write the sampling plots dataset to file
 #Plots = dbGetQuery(connection,"SELECT  Plots.Plot
 # , Ecotypes.Ecotype
 # , Plots.EstablishDate
 # , Plots.Crew
 # , Plots.Elev_m
 # , Plots.Lat
 # as Latitude
 # , Plots.Lon as Longitude
 # , Plots.NTransectLitterType
 # , Plots.NTransectLitterDepth
 # , Plots.SETransectLitterType
 # , Plots.SETransectLitterDepth
 # , Plots.SWTransectLitterType
 # , Plots.SWTransectLitterDepth
 # , Plots.CaribouSign
 # , Plots.SlopePosition
 # , Plots.SlopeCrossSection
 # , Plots.Drainage
 # , Plots.MicroRelief
 # , Plots.MicroReliefSize
 # , Plots.ParentRock
 # , Plots.ParentMaterial
 # , Plots.GeoMorphicDisturbance
 # , Plots.EvidenceOfFrostAction
 # , Plots.EvidenceOfFire
 # , Plots.EvidenceOfWind
 # , Plots.WindExposureClass
 # , Plots.SlopeLength
 # , Plots.AvgPrecip
 # , Plots.AvgPrecipUOM
 # , Plots.EcolSite
 # , Plots.MaxSlope
 # , Plots.SlopeAsp
 # , Plots.Notes
 # , Plots.EcotypeID
 # FROM Plots 
 # INNER JOIN Ecotypes ON Plots.EcotypeID = Ecotypes.EcotypeID
 # WHERE (NOT (Plots.EstablishDate IS NULL)) -- Exclude plots that have not yet been surveyed.
 # ORDER BY Plots.Plot")
 
# Write the sampling plots to file
#Filename = paste("CV-10 Plots.csv",sep="")
#WriteDataFrameToFile(Plots,Filename)




# Write the ecotypes dataset to file
# Ecotypes = dbGetQuery(connection,"SELECT Ecotype, DistinguishingFeatures, Cover, EcotypeID FROM Ecotypes ORDER BY Ecotype")
# Filename = paste("CV-10 Ecotypes.csv",sep="")
# WriteDataFrameToFile(Ecotypes,Filename)





# Write the species list dataset to file
# SpeciesList = dbGetQuery(connection,"SELECT [Family]
#       ,[Genus]
#       ,[Species]
#       ,[ScientificName]
#       ,[CommonName]
#       ,[LifeForm]
#       ,[GrowthHabit]
#       ,[GrowthHabitSub]
#       ,[synonymOf]
#       ,[GrowthHabitCode]
#       ,[Duration]
#       ,[Stabilizing]
#       ,[Invasive]
#       ,[Notes]
#       ,[SpeciesCode]
#   FROM [ChisanaVegetation].[dbo].[SpeciesList]
#   ORDER BY ScientificName")
# Filename = paste("CV-10 Species List.csv",sep="")
# WriteDataFrameToFile(SpeciesList,Filename)




# Write the deliverables schedule to file
# DeliverablesSchedule = dbGetQuery(connection,"SELECT * FROM DeliverablesSchedule ORDER BY DeliverableID")
# #Write the deliverables schedule plots to file
# Filename = paste("C-00 Deliverables Schedule - Chisana Vegetation Project.csv",sep="")
# WriteDataFrameToFile(DeliverablesSchedule,Filename)



# Write the fecal pellet dataset to file
# Notes on data processing steps to get to a good pellet dataset:
# The lab shipped a file to JAP (Putera 34 results.xlsx). The data was good in a pivoted, wide format that was untidy. 
# I cleaned it (Putera 34 results Copy.xlsx) and reformatted into a long and tidy (2015 Chisana Caribou Fecal Pellet Data.xlsx) format and imported it into the database (inpyugamsvm01\nuna_dev:ChisanaVeg).

# There were also a number of geodatabases containing the pellet collection locations. I merged these into a single file, CP-07 Fecal pellet collections spatial dataset.csv and imported them into the database.
# From there I joined the fecal composition data with the pellet collection locations joining on Sample and exported a pellet composition dataset with spatial locations for upload to Data Store: CP-05 Chisana Caribou Fecal Pellet Composition Dataset.csv; in the database this dataset is the view Dataset_FecalPellets).

# Get the fecal pellet dataset
# Sql = "SELECT  Sample, Form, Plant, PctComposition, Date, Year, Month, Lat, Lon, Elevation_m, Comment
# FROM Dataset_FecalPellets
# ORDER BY Sample, Form, Plant"
# PelletData = dbGetQuery(connection,Sql)
# Filename = paste("CP-05 Fecal pellet dataset.csv",sep="")
# WriteDataFrameToFile(PelletData,Filename)

```

```{r,label="Load data files from Data Store", echo=FALSE}
# Load data files
# Deliverables for this project are on the J drive with the path stored in the DeliverablesDirectory variable.
# In November 2024 they were moved to NPS Data Store at https://irma.nps.gov/DataStore/Reference/Profile/2306840.
# File paths to the J drive were commented out and replaced with URLs to Data Store so that NPS personnel can run 
# this markdown file from anywhere and reproduce the analyses done here.

# Read in the Chisana vegetation dataset
#Dataset_VegDataPath = paste(DeliverablesDirectory,Dataset_VegDataFilename,sep="") # Network drive
Dataset_VegDataPath = r'(https://irma.nps.gov/DataStore/DownloadFile/713149)' # Data Store
Dataset_VegData = read.csv(Dataset_VegDataPath,header=TRUE)

# Read in the sampling plots dataset
#PlotsPath = paste(DeliverablesDirectory,"CV-10 Plots.csv",sep="") # Network drive
PlotsPath = r'(https://irma.nps.gov/DataStore/DownloadFile/711702)' # Data Store
Plots = read.csv(PlotsPath,header=TRUE)

# Read in the ecotypes dataset
#EcotypesPath = paste(DeliverablesDirectory,"CV-10 Ecotypes.csv",sep="") # Network drive
EcotypesPath = r'(https://irma.nps.gov/DataStore/DownloadFile/711701)' # Data Store
Ecotypes  = read.csv(EcotypesPath,header=TRUE)

# Read in the fecal pellet dataset
#PelletDataPath = paste(DeliverablesDirectory,"CP-05 Fecal pellet dataset.csv",sep="") # Network drive
PelletDataPath = r'(https://irma.nps.gov/DataStore/DownloadFile/711686)' # Data Store
PelletData  = read.csv(PelletDataPath,header=TRUE)

# Read in the species list and species code abbreviations
#SpeciesListPath = paste(DeliverablesDirectory,"CV-10 Species List.csv",sep="") # Network drive
SpeciesListPath = r'(https://irma.nps.gov/DataStore/DownloadFile/713193)'
SpeciesList  = read.csv(SpeciesListPath,header=TRUE)

```

# Range Characterization and Diet of the Chisana Caribou Herd, Alaska

Authors, etc.

## Wrangell-St. Elias National Park and Preserve

# Abstract

[to be written]

# Introduction

[copied from LM's preliminary report]

The Chisana Caribou Herd (CCH) is a small herd of woodland caribou located in northeastern Wrangell St. Elias (WRST) National Park and Preserve in Alaska and the Tetlin National Wildlife Refuge in the Yukon. During the early 1990s, many caribou herds in interior Alaska experienced population declines of varying severity (Valkenburg et al., 1996). From 1989 to 2001, the CCH population dropped from an estimated 1800 to 400 individuals (R. Farnell, unpublished data). The CCH became listed as a “Specially Protected” population in 2002 under the Yukon’s Federal Species at Risk Act. After the implementation of a captive rearing program and the development of an international, multiagency management plan, the CCH population is now stable and open to subsistence hunting. However, the current population is significantly below pre-decline levels. Several factors most likely contributed to the CCH population decline including predation, low recruitment, and poor habitat.

Lichens may be the greatest feature limiting CCH habitat quality. Lichens comprise up to 60-86% of the winter diets of Yukon woodland caribou herds, while moss makes up only 1-8%, as estimated from the microhistological analysis of fecal pellets (Farnell and Gardner, 2002). Relative to other Alaskan and Yukon caribou, the CCH appear to have a winter diet that is unusually and low in lichen (31%) and high in moss (51%). Overflight landcover assessments and collections from a limited number of plots suggest that lichen cover with the range is sparse and dominated by nutrient-poor Stereocaulon species (Clarke and Waterreus, 2012), an indicator of poor winter habitat for reindeer (Swanson and Barker, 1992). More data on lichen and moss cover with the CCH range are needed to corroborate these results. In addition to cover, lichen biomass is an important measurement of caribou forage quality. If overgrazing occurs, lichen biomass may not be correlated with lichen cover, and caribou have shown preference for regions with low lichen cover, but high lichen biomass (Collins et al., 2010). Lichen biomass is commonly estimated from mean lichen mat thickness (Lieb, 1994; Arseneault et al., 1997; Moen et al. 2007; Collins et al., 2010). Therefore, measuring lichen thickness and cover in the CCH range may capture key details for assessing winter habitat.

Summer forage is also an important component of caribou habitat. Low recruitment in caribou populations in the Southern Alaska Peninsula is thought to be due to a combination of low winter lichen availability and poor summer range quality (Post and Klein, 1999). Caribou summer diet is typically composed of grasses, sedges, forbs, and willows (Boertje, 1984). Manipulation experiments within the CCH range suggest that climate change may affect caribou summer forage quality and abundance (Lenart et al., 2002). In this study, we aim to establish baseline monitoring of vegetation within the CCH range. Secondly, we estimate lichen cover and biomass across the CCH range to assess habitat quality relative to those of other caribou, particularly the neighboring Kluane, Aishihik, and Nelchina herds. In this report, we describe results from first season of data collection, present preliminary findings, and offer recommendations for future study years.

# Methods

```{r, label="Merkhofer's ecotypes assignment process", include=FALSE}


# NOTES: It appears that Merkhofer took Jorgenson et al. 2008's landcover classification and merged various subecotypes together into larger ecotypes. The Major ecotype column in Table 1, below, is Merkhofer's ecotype derived from the 'Included detailed ecotypes' which come from Jorgenson.

# Merkhofer documented her GIS work well in \\inpyugamsstor00\Primary Datapool\I&M\CAKN\CAKN2\Monitoring\Caribou\WRST\Projects\Chisana Caribou Habitat Assessment\Data\Habitat\Chisana Vegetation Sampling\)

# Merkhofer's steps as I can reproduce them:

# 1. She loaded Jorgenson's landcover into a geodatabase: J:\Monitoring\Caribou\WRST\Projects\Chisana Caribou Habitat Assessment\Data\Habitat\GIS\ChisanaCaribouHabitat.gdb as WRSTEcotypes2008Chisana

# 2. She combined various cover classes into larger major ecotypes and added a SamplingGroup column (example SWB corresponding to Subalpine Wood/Shrub)

# 3. These merged major ecotypes became a feature class Ecotypes_in_one_shapefile. This layer is what is shown in Figure 2 of the Merkhofer, 2015 report

# 4. She then chose potential veg plot locations in the major ecotypes for locating sampling plots (Chisana_Veg_Sampling_Points in the geodatabase, APPENDIX A. RANDOM SITE LOCATIONS AND STUDY STATUS in her report)


```

## Study Area

We focus on the core range of the CCH within WRST National Park and Preserve boundaries. This area forms the basin between the Wrangell, St. Elias, and Nutzotin Mountains, containing the Chisana and White Rivers and the historic town of Chisana. Study area limits were defined to include the bulk of CCH radio collar signals recorded between 1988 and 2015 (Fig. 1; J. Putera, unpublished data, 2015). The resulting area is 2795 km^2^ (1079 miles^2^ ) and contains moderate to high elevations, from 1000 - 2500 m (3281–8202 ft).

We chose to proportionally allocate sampling sites to six major ecotypes within the study area (Table 1). Major ecotypes were developed by consolidating the detailed ecotypes mapped in WRST by Jorgenson et al. (2008) using satellite imagery. We grouped Jorgenson et al. ecotypes into groups based on the similarity of their definitions and geographic size (Table 1; Fig. 2). We included all ecotypes except for glaciated barrens. In our study region, the three most common ecotypes by percent cover are Alpine Dwarf Shrub/Barrens (28.1%), Subalpine Wood/Shrub (28.1%), and Alpine Sedge-Dwarf Shrub (24.3%). Riverine, Alpine Meadow, and Forest ecotypes make up the remaining 19.4% of the region.

Table 1. Ecotypes of Chisana caribou herd range, ranked by percent cover.

+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
|       | **Major ecotype**          | **Included detailed ecotypes\*** | **Distinguishing features**                                                                                                                  | **Landcover** |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 1     | Alpine Dwarf-Shrub/Barrens | Alpine Dryas Dwarf Shrub         | *Dryas* spp. and other evergreen dwarf shrubs dominant, trees or tall shrubs absent, and rare graminoids; occurs at high elevations          | 28.1%         |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Barrens                   |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Ericaeous Dwarf Shrub     |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 2     | Subalpine Wood/Shrub       | Subalpine Willow-Birch Shrub     | Characterized by tall (\> 0.2 m) deciduous shrubs; few sedges and grasses; tree cover \< 20%                                                 | 28.1%         |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Subalpine Spruce Woodland        |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 3     | Alpine Sedge-Dwarf Shrub   | Alpine Sedge-Dwarf Willow Meadow | Deciduous shrubs dominant, but with lower frequencies than in ecotype 2; sedges co-dominant; trees absent; relatively high species diversity | 24.3%         |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 4     | Riverine                   | Riverine Circumalkaline Barrens  | On or near braided streams; deciduous or evergreen dwarf shrubs are dominant and trees uncommon                                              | 7.5%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Sandy Willow Shrub      |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Dryas Dwarf Shrub       |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Tall Alder Shrub        |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Low Silverberry Shrub   |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 5     | Alpine Meadow              | Alpine Tussock Meadow            | Tussocks \> 25% and sedge cover approaching 60%; dwarf shrubs can be co-dominant; no trees; wet soil                                         | 7.3%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Sedge Meadow              |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 6     | Forest                     | Subalpine Poplar Forest          | Common on or near overbank deposits; characterized by \> 20% tree cover and thick mossy floor                                                | 4.6%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine White Spruce Forest     |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Gravelly Poplar Forest  |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Spruce-Poplar Forest    |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+

: caption

We generated 56 random points for site locations within the Chisana caribou herd range (Appendix A). We included a 3000 m buffer between sites to ensure an even geographic distribution throughout the study area. Points that fell within rivers were moved to the nearest accessible riverine ecotype and points on excessively steep terrain were eliminated. We re-assigned ecotypes after field data collection using the formal WSRT ecotype classification key (summarized in Table 1; Jorgenson et al., 2008). We visited 23 sites in July, 2015 and 10 sites in July, 2016. Sites were accessed by helicopter or foot using a Trimble or Garmin GPS for navigation (Fig. 3). Permanent plots were established at all sites except those falling with a proposed Archeological District around Wiki Peak. Permanent plots were marked with a 60 cm-long rebar located at plot centers. At each site, we described physical landscape characteristics such as slope position, drainage, and geomorphic disturbance.

![](images/clipboard-3865551050.png)

Figure 1. Defining the core range of the Chisana caribou herd in northeastern WRST Park and Preserve. Points are radio collar signals recorded from 1988 to 2015 during summer or winter seasons. The core range (yellow border) was selected to include the majority of radio signals within WRST (green border).

![](images/clipboard-954225469.png)

Figure 2. Major ecotypes within the Chisana caribou range in northeastern WRST Park and Preserve (Table 1). Map based on ecotype landcover developed by Jorgenson et al. (2008).

```{r, label="Map of sampling plots", echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Map of sampling plots.",sep="")}
# Increment the figure counter
FigureCounter = FigureCounter + 1

# Map the units in Leaflet
leaflet() %>%
  
  # Set the view and zoom levels
  setView(lng = mean(Plots$Longitude), lat = mean(Plots$Latitude), zoom = 9) %>%
  
  # Add WMS tiles
  addWMSTiles('https://basemap.nationalmap.gov:443/arcgis/services/USGSTopo/MapServer/WmsServer',layers = "0",options = WMSTileOptions(format = "image/png"))  %>%

  # Add the points
  addCircleMarkers(lng = Plots$Longitude, lat = Plots$Latitude, popup = Plots$Plot, color=) %>%
 
  # Label the units 
  addLabelOnlyMarkers(~Longitude,~Latitude, label = ~Plot, data = Plots,  labelOptions = labelOptions(noHide = TRUE))

```


```{r,label="Get spatial data and generate a map", echo = FALSE}
# 
# PlotsSDF = st_as_sf(Plots, coords = c("Longitude", "Latitude"), crs = 4326)
# 
# bboxdf = sqldf("SELECT Min(Latitude) as MinLat,Max(Latitude) as MaxLat,Min(Longitude) as MinLon,Max(Longitude) as MaxLon FROM Plots")
# 
# # Load in the park boundaries geojson file from Data Store
# # Reference URL: https://irma.nps.gov/DataStore/Reference/Profile/2303652
# AK_ParksGeoJSON = "https://irma.nps.gov/DataStore/DownloadFile/704836"
# AK_Parks <- read_sf(AK_ParksGeoJSON,crs=4326)
# 
# # Expansion factor to add to bounding box values so there is a little space between the units and the polygons
# expansionFactor = 1.002
# 
# # Plot the GSPE data
# ggplot() +
#   # Park boundary
#   geom_sf(data=AK_Parks,fill='gray90',color="black",alpha=1) + # Park boundaries
#   geom_sf(data = PlotsSDF) +
# 
#   # Label the units with the number of moose observed
#   #geom_text(data = UnitsWithMooseSpatialDF, mapping = aes(x = Longitude, y = Latitude, label = Moose), size = 3, color = "black") +
# 
#   # Limit the map to the area around the survey units
#   coord_sf(xlim = c(bboxdf$MinLon, bboxdf$MaxLon),ylim = c(bboxdf$MinLat,bboxdf$MaxLat),expand=TRUE) + # Limit to bounding box of surveyed
# 
#   ggtitle("PlotTitle") +
# 
#   theme_minimal() + # Minimal theme
#   theme(
#     panel.background = element_rect(fill = "white", color = NA),  # Background color of the panel
#     plot.background = element_rect(fill = "white", color = NA),       # Background color of the plot
#     panel.grid.major = element_line(color = "black"),                # Major grid lines
#     panel.grid.minor = element_line(color = "black")                 # Minor grid lines
#   )


```

```{r}

# # Define the WMS URL
# wms_url <- "https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/export"
# 
# # Parameters for the WMS request
# params <- list(
#   bbox = "-150,60,-130,63",  # Bounding box coordinates (minx, miny, maxx, maxy)
#   size = "800,600",         # Image size (width,height)
#   format = "png",           # Image format
#   f = "image",              # Response format
#   layers = "0",             # Layer to include
#   bboxSR = "4326",          # Spatial reference of the bounding box
#   imageSR = "4326"          # Spatial reference of the image
# )
# 
# # Construct the full URL with parameters
# full_url <- paste0(wms_url, "?", paste0(names(params), "=", params, collapse = "&"))
# 
# # Set your download directory (e.g., Desktop)
# download_dir <- "C:/Temp"
# 
# # Define the full path to save the raster
# temp_file <- file.path(download_dir, "usgs_topo.png")
# 
# # Download the WMS data
# download.file(url = full_url, destfile = temp_file, mode = "wb")
# 
# # Check if the file exists
# if (file.exists(temp_file)) {
#   message("File downloaded successfully to ", temp_file)
# } else {
#   stop("Error: File download failed.")
# }
# 
# # Read the raster data using terra
# raster_data <- rast(temp_file)
# 
# # Convert the raster to a data frame
# raster_df <- as.data.frame(raster_data, xy = TRUE, na.rm = TRUE)
# 
# # Create a ggplot with the raster data
# ggplot() +
#   geom_raster(data = raster_df, aes(x = x, y = y, fill = usgs_topo)) +
#   scale_fill_viridis_c() +
#   #coord_quickmap() +
#     # Limit the map to the area around the survey units
#   coord_sf(xlim = c(bboxdf$MinLon, bboxdf$MaxLon),ylim = c(bboxdf$MinLat,bboxdf$MaxLat),expand=TRUE) + # Limit to bounding box of surveyed
#   theme_minimal() +
#   labs(title = "USGS Topo WMS Raster Plot")


```


## Ecotypes

Table 1. Ecotypes of Chisana caribou herd range, ranked by percent cover.

+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
|       | **Major ecotype**          | **Included detailed ecotypes\*** | **Distinguishing features**                                                                                                                  | **Landcover** |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 1     | Alpine Dwarf-Shrub/Barrens | Alpine Dryas Dwarf Shrub         | *Dryas* spp. and other evergreen dwarf shrubs dominant, trees or tall shrubs absent, and rare graminoids; occurs at high elevations          | 28.1%         |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Barrens                   |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Ericaeous Dwarf Shrub     |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 2     | Subalpine Wood/Shrub       | Subalpine Willow-Birch Shrub     | Characterized by tall (\> 0.2 m) deciduous shrubs; few sedges and grasses; tree cover \< 20%                                                 | 28.1%         |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Subalpine Spruce Woodland        |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 3     | Alpine Sedge-Dwarf Shrub   | Alpine Sedge-Dwarf Willow Meadow | Deciduous shrubs dominant, but with lower frequencies than in ecotype 2; sedges co-dominant; trees absent; relatively high species diversity | 24.3%         |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 4     | Riverine                   | Riverine Circumalkaline Barrens  | On or near braided streams; deciduous or evergreen dwarf shrubs are dominant and trees uncommon                                              | 7.5%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Sandy Willow Shrub      |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Dryas Dwarf Shrub       |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Tall Alder Shrub        |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Low Silverberry Shrub   |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 5     | Alpine Meadow              | Alpine Tussock Meadow            | Tussocks \> 25% and sedge cover approaching 60%; dwarf shrubs can be co-dominant; no trees; wet soil                                         | 7.3%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Alpine Sedge Meadow              |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+
| 6     | Forest                     | Subalpine Poplar Forest          | Common on or near overbank deposits; characterized by \> 20% tree cover and thick mossy floor                                                | 4.6%          |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine White Spruce Forest     |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Gravelly Poplar Forest  |                                                                                                                                              |               |
|       |                            |                                  |                                                                                                                                              |               |
|       |                            | Riverine Spruce-Poplar Forest    |                                                                                                                                              |               |
+-------+----------------------------+----------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------+---------------+

Why only one plot in Forest? Merkhofer: "We found that Forest ecotypes made for difficult helicopter landing access and subsequently sampled only one site from this ecotype. Future sampling should be targeted to these under-sampled ecotypes."

```{r, label="Table of number of plots by ecotype", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Number of plots by ecotype.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

# Display the sampling plots
knitr::kable(sqldf("SELECT Ecotype,Count(Ecotype) as n 
FROM Plots
Group By Ecotype
ORDER BY n DESC"))

```

## Vegetation Cover

We recorded vegetation along three 20 m-long transects oriented at 0, 120, and 240° from the plot center (Figure 4). Each transect was photographed and measured for slope. Transects were systematically sampled at 50 cm intervals using the line-point intercept method for 40 observations per transect. At each point, we recorded all intercepted overstory and understory taxa, soil surface cover, and lichen height. We identified taxa to the species or genus-level. We considered forage lichen as the genera Cladina, Cladonia (excluding species with cup-shaped podetia), Cetraria (excluding C. richardsonii), and Stereocaulon, following Collins et al. (2011). We estimated the percent cover of major life forms across the entire study area as the average of ecotype means weighted by ecotype area. Percent cover was calculated for each plot as total number of plant intercepts by species divided by 120 (3 transects X 40 sampling points).

**[I didn't do the below because I need help with it]**

**Following the methods recommended by Elzinga et al. (1998), we sequentially sampled percent cover values to test for a stable estimate of the overall population mean and standard deviation. We additionally used two-tailed significance tests to determine the necessary sample size for estimating percent cover for a single population and for detecting differences in percent cover between two time periods.**

![](images/clipboard-3907250847.png)

Fig 4. Plot design schematic showing locations of transects.

## Lichen Thickness and Estimated Biomass

Lichen height was measured using a 3 mm-wide metal skewer inserted into the base of the lichen mat (Arseneault et al., 1997; Moen et al. 2007; Collins et al., 2010) at each of the 40 vegetation intercept points per transect. We calculated the mean lichen height of each plot as the average of all heights, including zero heights where no lichen was present. We estimated lichen biomass (kg/ha) for each plot from mean lichen height using the Moen et al. (2007) regression based on four forage lichen species:

$B=1135.6T$,

where T is mean lichen mat thickness (cm).

## Litter Depth and Composition

Litter depth was sampled from 10 cm-diameter soil plugs removed at the terminus of each transect. Our litter depth measurements include the height of any living mat-forming vegetation, such as moss. We calculated an average litter depth from each plot's three transects.

## Fecal Pellet Analysis

We collected 34 fecal pellets in the winters of 2015 and 2016 for diet analysis (Table `r TableCounter`). We sent these samples to [NEED THE LAB HERE] for plant composition analysis.

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Number of pellets collected by year and month.",sep=""),warning=FALSE}
knitr::kable(PelletData %>% group_by(Year,Month) %>% summarise(n=n_distinct(Sample)) %>% arrange(Year,Month))
```

We collected 34 fecal pellets from the range of the Chisana caribou herd in in order to quantify what plants the Chisana caribou were feeding on. Collected fecal pellets were analyzed for taxa by XXX lab.

## Caribou Ecotype Preference

WRST has spatial locations for Chisana caribou from GPS collars from April, 2020 through September, 2024. Using Geographic Inoformation Systems (GIS), we overlaid the caribou location data on our landcover GIS layer and appended the ecotype bounding each location as an attribute to each GPS fix. We then summed the number of locations encompassed by each ecotype, telling us the proportion of time each caribou spent in each ecotype.

# Results

## Vegetation Cover

```{r, label="Dataset: Generate percent cover dataset", echo=FALSE}

# Calculate percent cover from the vegetation dataset for each species over the entire dataset 
# Start by getting the entire list of species
Sql = "SELECT ScientificName

-- Now add in the counts of intercepts by stratum by species (UPPER() ensures that the species codes, which are sometimes inconsistent in case, match)
, (SELECT COUNT(TopCanopy) AS n FROM Dataset_VegData v where UPPER(v.TopCanopy) = UPPER(s.SpeciesCode))  as TopCanopyIntercepts
, (SELECT COUNT(Lower1) AS n FROM Dataset_VegData v where UPPER(v.Lower1) = UPPER(s.SpeciesCode)) as Lower1Intercepts
, (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v where UPPER(v.Lower2) = UPPER(s.SpeciesCode)) as Lower2Intercepts
, (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v where UPPER(v.Lower3) = UPPER(s.SpeciesCode)) as Lower3Intercepts

-- Sum the mid-story strata by adding the Lower1-3 strata intercept counts together
, (SELECT COUNT(Lower1) AS n FROM Dataset_VegData v where UPPER(v.Lower1) = UPPER(s.SpeciesCode))
	  + (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v where UPPER(v.Lower2) = UPPER(s.SpeciesCode))
	  + (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v where UPPER(v.Lower3) = UPPER(s.SpeciesCode))
	as LowerInterceptsCombined
	
-- Count the number of soil surface intercepts for the current species
, (SELECT COUNT(SoilSurface) AS n FROM Dataset_VegData v where UPPER(v.SoilSurface) = UPPER(s.SpeciesCode)) as SoilSurfaceIntercepts

-- Total number of possible intercepts 
,(SELECT Count(*) as n FROM Dataset_VegData) as TotalHitsPossible 

-- TopCanopy Percent Cover: Add up the total number of intercepts for the current species and divide by the total number of hits that were possible
, (SELECT Cast(COUNT(TopCanopy) as Float) AS n FROM Dataset_VegData v where UPPER(v.TopCanopy) = UPPER(s.SpeciesCode)) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_TopCanopy

-- Lower1 Percent Cover: Add up the total number of intercepts for the current species and divide by the total number of hits that were possible
, Cast((SELECT COUNT(Lower1) AS n FROM Dataset_VegData v where UPPER(v.Lower1) = UPPER(s.SpeciesCode)) As Float) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_Lower1

-- Lower2 Percent Cover: Add up the total number of intercepts for the current species and divide by the total number of hits that were possible
, Cast((SELECT COUNT(Lower2) AS n FROM Dataset_VegData v where UPPER(v.Lower2) = UPPER(s.SpeciesCode)) As Float) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_Lower2

-- Lower3 Percent Cover: Add up the total number of intercepts and divide by the total number of hits that were possible
, Cast((SELECT COUNT(Lower3) AS n FROM Dataset_VegData v where UPPER(v.Lower3) = UPPER(s.SpeciesCode)) As Float) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_Lower3

-- Lower intercepts combined cover: Add up all the hits for Lower1-3 and divide by the total number of hits that were possible times 3
-- Cast the numerator from int to float so that the result gets decimal places rather than being an int
, Cast(((SELECT COUNT(Lower1) AS n FROM Dataset_VegData v where UPPER(v.Lower1) = UPPER(s.SpeciesCode)) -- Lower1 total hits
	+ (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v where UPPER(v.Lower2) = UPPER(s.SpeciesCode)) -- Lower2 total hits
	+ (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v where UPPER(v.Lower3) = UPPER(s.SpeciesCode))) As Float) -- Lower3 total hits
	 / ((SELECT Count(*) as n FROM Dataset_VegData) * 3) * 100 -- Total hits possible times 3 for the three strata, Lower1-3
	as PctCover_LowerInterceptsCombined

-- Soil Surface Percent Cover: Add up the total number of intercepts and divide by the total number of hits that were possible
, Cast((SELECT COUNT(SoilSurface) AS n FROM Dataset_VegData v where UPPER(v.SoilSurface) = UPPER(s.SpeciesCode)) As Float) 
    / ((SELECT Count(*) as n FROM Dataset_VegData)) * 100 as PctCover_SoilSurface

,UPPER(SpeciesCode)
,GrowthHabitSub
FROM SpeciesList s
ORDER BY ScientificName"

# Generate a data frame of cover values by species
CoverData = sqldf(Sql)

# Write the deliverables schedule plots to file
# Filename = paste("CV-10 Percent Cover By Species.csv",sep="")
# WriteDataFrameToFile(CoverData,Filename)

#knitr::kable(CoverData,digits=2)

```

### Foliar cover

\*Unweighted by ecotype area.

Question: Merkhofer states "We estimated the percent cover of major life forms across the entire study area as the average of ecotype means weighted by ecotype area." She did not give a formula. I'm uncertain how to weight means. The tables below give gover as the number of point intercept hits divided by the total number of available tries, unweighted by ecotype area.]

Results:

-   Overall foliar plant cover in the vegetation plots we sampled was dominated by dwarf birch, sedges, *Dryas* and willow, species emblematic of alpine tundra.

```{r, label="Figure: Foliar percent cover",echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Foliar percent cover across all sampling plots in the Chisana caribou herd range.",sep="")}
FoliarCover = sqldf("SELECT ScientificName as Taxa,PctCover_TopCanopy as [% cover] 
FROM CoverData 
WHERE GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic')
And PctCover_TopCanopy > 1
AND PctCover_TopCanopy > 0
ORDER BY PctCover_TopCanopy DESC")

ggplot(FoliarCover) +
      geom_col(aes(x=reorder(Taxa,-`% cover`),y=`% cover`)) +
      ggtitle("Foliar cover") +
      xlab("Point intercept") +
      theme_minimal() +
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
      xlab("Taxa") +
      ylab("% cover")

# Increment the figure counter
FigureCounter = FigureCounter + 1
```

```{r,label="Table: Percent foliar cover", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Percent foliar cover by taxa in the range of the Chisana caribou herd having cover greater than 1%.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

# Print the foliar (TopCanopy stratum) cover.
knitr::kable(FoliarCover,digits=0)
```

<!-- ### Mid-story Cover -->

<!-- -   Mid-story percent cover values are very low because of diminishing likelihood of a hit in Lower2 and exponentially diminishing likelihood of a hit on Lower3. We can't just sum Lower1-3 and divide by the number of hit opportunities. LM ignored Lower1-3, probably for this reason? Or should we just use Lower1? -->

<!-- \*Unweighted by ecotype area. -->

<!-- ```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Percent mid-story cover by taxa in the range of the Chisana caribou herd having cover greater than 0.1%.",sep="")} -->

<!-- # Increment the table counter -->

<!-- TableCounter = TableCounter + 1 -->

<!-- # Print the mid-story (Lower1-3 strata) cover. -->

<!-- knitr::kable(sqldf("SELECT ScientificName as Taxa,PctCover_LowerInterceptsCombined as [% cover]  -->

<!-- FROM CoverData  -->

<!-- WHERE GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic') -->

<!-- AND PctCover_LowerInterceptsCombined > 0.1 -->

<!-- ORDER BY PctCover_LowerInterceptsCombined DESC")) -->

<!-- ``` -->

### Basal Cover

\*Unweighted by ecotype area.

```{r, label="Figure: Basal percent cover across all plots",echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Basal percent cover across all sampling plots in the Chisana caribou herd range.",sep="")}
BasalCover = sqldf("SELECT ScientificName as Taxa,PctCover_SoilSurface as [% cover] 
FROM CoverData 
WHERE GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic')
And PctCover_TopCanopy > 1
AND PctCover_TopCanopy > 0
ORDER BY PctCover_TopCanopy DESC")

ggplot(BasalCover) +
      geom_col(aes(x=reorder(Taxa,-`% cover`),y=`% cover`)) +
      ggtitle("Basal cover") +
      xlab("Point intercept") +
      theme_minimal() +
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
      xlab("Taxa") +
      ylab("% cover")

# Increment the figure counter
FigureCounter = FigureCounter + 1
```

```{r, label="Table: Percent basal cover by taxa", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Percent basal cover by taxa in the range of the Chisana caribou herd having cover greater than 0.1%.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

# Print the basal (SoilSurface stratum) cover.
knitr::kable(BasalCover,digits=0)



```

## Vegetation diversity

```{r,label="Table: Overall diversity", echo=FALSE, tab.cap=paste("Table ",TableCounter,". Overall plant diversity.",sep="")}
DistinctSpecies = 
sqldf("
SELECT Distinct TopCanopyScientificName As Taxa FROM Dataset_VegData
UNION
SELECT Distinct Lower1ScientificName As Taxa FROM Dataset_VegData
UNION
SELECT Distinct Lower2ScientificName As Taxa FROM Dataset_VegData
UNION
SELECT Distinct Lower3ScientificName As Taxa FROM Dataset_VegData
UNION
SELECT Distinct SoilSurfaceScientificName As Taxa FROM Dataset_VegData
")

Diversity = sqldf("SELECT d.Taxa,s.Family,s.Genus,s.CommonName As [Common name],LifeForm as [Life form],GrowthHabit as [Growth habit],GrowthHabitSub as [Sub-growth habit] FROM DistinctSpecies d Inner Join SpeciesList s on d.Taxa = s.ScientificName
WHERE 
(GrowthHabitSub <> 'Abiotic') And
(Family IS NOT NULL) And
(Family <> '')
ORDER BY Taxa")

knitr::kable(Diversity)

TableCounter = TableCounter + 1
```

## Lichen Layer Thickness and Biomass

NOTES on lichen biomass: I'm using LM's conversion of lichen height to biomas "We estimated lichen biomass for each plot from mean lichen height using the Moen et al. (2007) regression based on four forage lichen species as B=1135.6T where T is mean lichen mat thickness (cm) and B is mean lichen mat biomass (kg/ha). ,1135.6 \* AVG(IFNULL(v.LichenHeight,0)) as [Estimated lichen biomass (kg/ha)" without really knowing much about that methodology.

Also Moen et al. considered 4 leafy lichens. LM and JP did not distinguish any species of lichens in their lichen height measument at each point intercept ("We calculated the mean lichen height of each plot as the average of all heights, including zero heights where no lichen was present").

Mean lichen thickness in all study plots averaged 1.45cm, ranging from no lichen cover to a maximum thickness of 7.5cm. Mean lichen thickness by plot ranged from 0.83cm in the Riverine ecotype (3 plots), to 2.77 in the Forest ecotype (Figure 9, Table 6). The Forest ecotype showed the thickest lichen cover, but consists of only a single plot. Analysis of variance between ecotype and lichen thickness was significant (p=2e-16). Tukey's pairwise honest significance test showed that, except for three pairwise comparisons, ecotypes differed significantly in terms of lichen thickness. Lichen thickness similarity was highest among the Subalpine Wood/Shrub, Alpine Sedge/Dwarf Shrub and Alpine Meadow ecotypes (Figure 11.)

```{r,label="Dataset: Generate Biomass dataset", echo=FALSE}

# Get the lichen thickness and biomass data
Sql="SELECT Ecotype

-- NOTE: I used IFNULL() to convert NULL values to zero because data collectors left lichen height field blank where no lichens were observed on transect points.
-- LM's methods section states that lichen height was measured at each point intercept, therefore NULLs should, in fact, be zeros.
, AVG(IFNULL(v.LichenHeight,0)) AS [Mean lichen thickness (cm)]
, MIN(IFNULL(v.LichenHeight,0)) AS Min
, MAX(IFNULL(v.LichenHeight,0)) AS Max
, STDEV(IFNULL(v.LichenHeight,0)) AS SD

-- We estimated lichen biomass for each plot from mean lichen height using the Moen et al. (2007) regression based on four forage lichen species as B=1135.6T where T is mean lichen mat thickness (cm) and B is mean lichen mat biomass (kg/ha).
,1135.6 * AVG(IFNULL(v.LichenHeight,0)) as [Estimated lichen biomass (kg/ha)] 

-- Biomass estimate lower by one standard deviation, the case statement returns zero in cases where the mean lichen thickness minus one standard deviation is zero in which case biomass should be zero
,Case 
  When AVG(IFNULL(v.LichenHeight,0)) - STDEV(IFNULL(v.LichenHeight,0)) < 0 Then 0 
  Else AVG(IFNULL(v.LichenHeight,0)) - STDEV(IFNULL(v.LichenHeight,0)) * 1135.6 
 End As [Biomass lower estimate] 

-- Biomass estimate upper by one standard deviation
,1135.6 * (AVG(IFNULL(v.LichenHeight,0)) + STDEV(IFNULL(v.LichenHeight,0))) as [Biomass upper estimate] 

, COUNT(*) AS n
, COUNT(DISTINCT Plot) as [Number of plots]
, COUNT(Line) as [Number of transects]
,EcotypeID
FROM Dataset_VegData v 
GROUP BY Ecotype,EcotypeID
ORDER BY [Mean lichen thickness (cm)]  DESC"

Biomass = sqldf(Sql)

```

```{r,label="Lichen height: Normality plots"}

# Binwidth <- (max(Dataset_VegData$LichenHeight,na.rm=TRUE) - min(Dataset_VegData$LichenHeight,na.rm=TRUE)) / ceiling(log2(nrow(Dataset_VegData %>% filter(is.na(LichenHeight)==FALSE))) )
# ggplot(Dataset_VegData) + 
#     geom_histogram(aes(x=LichenHeight),na.rm=TRUE,binwidth=Binwidth) + 
#     theme_minimal() +
#     ggtitle("Distribution of lichen thickness data")
# 
# # Create Quantile-Quantile plot
# data = Dataset_VegData %>% select(LichenHeight) %>% filter(is.na(LichenHeight)==FALSE)
# qqnorm(Dataset_VegData$LichenHeight)
# qqline(data, col = "red")
# 
# # Perform Shapiro-Wilk test
# shapiro.test(Dataset_VegData$LichenHeight)
# 
# ks.test(Dataset_VegData$LichenHeight, "pnorm", mean = mean(Dataset_VegData$LichenHeight), sd = sd(Dataset_VegData$LichenHeight))

```

```{r,label="Dataset: Generate overall mean lichen height summary",tab.cap=paste("Table ",TableCounter,". Overall lichen thickness (cm) summary, Chisana caribou herd range.",sep="")}
# Generate a summary of overall lichen thickness
OverAllLichenThicknessSummary = Dataset_VegData %>% 
  filter(!is.na(LichenHeight)) %>%
  summarize(Mean=mean(LichenHeight,na.rm=TRUE),
            `S.D.`=sd(LichenHeight,na.rm=TRUE),
            Min=min(LichenHeight,na.rm=TRUE),
            Max=max(LichenHeight,na.rm=TRUE),
            n=n())
knitr::kable(t(OverAllLichenThicknessSummary),digits=2)
```

```{r,label="Dataset: Generate mean lichen height by plot dataset"}

# Moen et al. (2007) lichen thickness to biomass conversion
LichenHtToBiomassConversionFactor = 1135.6 

# Start by calculating mean lichen heights by plot
MeanLichenHeightByPlot = Dataset_VegData %>% select(Ecotype,Plot,Line,PointLoc,LichenHeight) %>% 
  filter(is.na(LichenHeight) == FALSE) %>% 
  group_by(Plot) %>% 
  summarize(
    Plots=n_distinct(Plot)
    ,Transects=n_distinct(Line)
    ,NonNullLichenHeights=n()
    ,`Mean lichen thickness (cm)`=mean(LichenHeight)
    ,`SD (thickness)`=            sd(LichenHeight)
    ,`Estimated biomass (kg/ha)`= mean(`Mean lichen thickness (cm)` * LichenHtToBiomassConversionFactor)
    ,`SD (biomass)`=              sd(LichenHeight * LichenHtToBiomassConversionFactor,na.rm=TRUE)
  ) %>%
  arrange(Plot)

# Join the results to the Plots table in order by add the Ecotype back in so we can calculate statistics by ecotype
MeanLichenHeightByPlot = inner_join(MeanLichenHeightByPlot,Plots,by='Plot') %>% select(Ecotype,Plot,Plots,Transects,NonNullLichenHeights,`Mean lichen thickness (cm)`,`SD (thickness)`,`Estimated biomass (kg/ha)`,`SD (biomass)`)

# Weird fix needed here: I duplicated the lichen thickness column as MeanHt because the dplyr standard deviation calculations below refused to work on a column named `Mean lichen thickness (cm)`
MeanLichenHeightByPlot$MeanHt = MeanLichenHeightByPlot$`Mean lichen thickness (cm)` 

# Next calculate mean lichen height by ecotype (mean of mean lichen height by plot)
MeanLichenHeightByEcotype = MeanLichenHeightByPlot %>% group_by(Ecotype) %>% 
  #filter(Ecotype == 'Alpine Dwarf Shrub/Barrens') %>%
  summarise(
    Plots=sum(Plots)
    ,Transects=sum(Transects)
    ,`Mean lichen thickness (cm)`= mean(`Mean lichen thickness (cm)`)
    ,`SD (thickness)`=sd(MeanHt,na.rm=TRUE) # Note: SD is calculated on MeanHt instead of `Mean lichen thickness (cm)` because dplyr wouldn't give me an SD on that column name so I had to create a duplicate column
    ,`Estimated biomass (kg/ha)`=mean(`Mean lichen thickness (cm)` * LichenHtToBiomassConversionFactor)
    ,`SD (biomass)`=sd(MeanHt * LichenHtToBiomassConversionFactor,na.rm=TRUE)
    ,n=sum(NonNullLichenHeights)
  )

# Generate a summary of overall lichen thickness
OverAllLichenThicknessSummary = Dataset_VegData %>% 
  filter(!is.na(LichenHeight)) %>%
  summarize(Mean=mean(LichenHeight,na.rm=TRUE),
            SD=sd(LichenHeight,na.rm=TRUE),
            Min=min(LichenHeight,na.rm=TRUE),
            Max=max(LichenHeight,na.rm=TRUE),
            SD=sd(LichenHeight,na.rm=TRUE),
            n=n())

```

```{r,label="Figure: Mean lichen thickness and estimated biomass by ecotype", echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Mean lichen thickness (cm) and estimated biomass (kg/Ha) by ecotype. Biomass estimated according to Moen et al.,(2007). Error bars represent one standard deviation. Note that only one plot was sampled in the Forest ecotype.",sep="")}

ggplot(MeanLichenHeightByEcotype) +
  # Mean lichen height column chart
  geom_col(aes(x=Ecotype,y=`Mean lichen thickness (cm)`),fill='lightgray',color='darkgray') +
  
  # Error bars as standard deviation
  geom_errorbar(aes(x=Ecotype,ymin=`Mean lichen thickness (cm)` - `SD (thickness)`,ymax=`Mean lichen thickness (cm)` + `SD (thickness)`),width=0.2) +
  geom_text(aes(x=Ecotype,y=`Mean lichen thickness (cm)`
                ,label=paste( round(`Mean lichen thickness (cm)`,digits=2)," cm\n(",round(`Estimated biomass (kg/ha)`,digits=2)," kg/Ha)",sep=""))
    ,size=3,vjust=2.2) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("Mean lichen thickness and estimated biomass by ecotype")

#Increment the figure counter
FigureCounter=FigureCounter+1

```

```{r,label="Table: Mean lichen thickness (cm) by ecotype", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Mean lichen thickness (cm) by ecotype.  Note that only one plot was sampled in the Forest ecotype..",sep="")}

# Output the lichen thickness by ecotype
knitr::kable(MeanLichenHeightByEcotype %>% rename(SD=`SD (thickness)`) %>% select(Ecotype,Plots,Transects,`Mean lichen thickness (cm)`,SD,n), digits = 2)

# Increment the table counter
TableCounter = TableCounter + 1

```

```{r,label="Table: Estimated biomass by Ecotype", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Mean estimated lichen biomass (kg/Ha) by ecotype. Biomass estimated according to Moen et al.,(2007) Note that only one plot was sampled in the Forest ecotype..",sep="")}

# Output the lichen estimated biomass by ecotype
knitr::kable(MeanLichenHeightByEcotype %>% rename(SD=`SD (biomass)`) %>% select(Ecotype,Plots,Transects,`Estimated biomass (kg/ha)`,SD,n), digits = 2)


# Increment the table counter
TableCounter = TableCounter + 1

```

```{r,label="Figure: Mean lichen thickness by plot", echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Mean lichen thickness (cm) by plot Error bars represent one standard deviation. Note that only one plot was sampled in the Forest ecotype.",sep="")}

ggplot(MeanLichenHeightByPlot) +
  # Mean lichen height column chart
  geom_col(aes(x=Plot,y=`Mean lichen thickness (cm)`,fill=Ecotype)) +
  
  # Error bars as standard deviation
  geom_errorbar(aes(
    x=Plot
    ,ymin=ifelse(`Mean lichen thickness (cm)` - `SD (thickness)` < 0,0,`Mean lichen thickness (cm)` - `SD (thickness)`)
    ,ymax=`Mean lichen thickness (cm)` + `SD (thickness)`),width=0.5,color='gray') +
  geom_text(aes(x=Plot,y=`Mean lichen thickness (cm)`,label=round(`Mean lichen thickness (cm)`,digits=2)) ) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))  +
  ggtitle("Mean lichen thickness by plot")

#Increment the figure counter
FigureCounter=FigureCounter+1
```

```{r,label="Lichen height: ANOVA of LichenHeight ~ Ecotype"}

# Get just the lichen thickness data by ecotype into a data frame
LichenData = Dataset_VegData %>% filter(!is.na(LichenHeight)) %>% select(Ecotype,LichenHeight,Plot,Line,PointLoc) %>%    arrange(Ecotype,LichenHeight)
# The dash in Ecotype will confuse the tukey results, replace with slash
LichenData$Ecotype = gsub("-","/",LichenData$Ecotype) 

# Do the anova
anova_result <- aov(LichenHeight ~ Ecotype,  data = LichenData)
summary(anova_result)

```

```{r,label="Lichen height: Tukey test",tab.cap=paste("Table ",TableCounter,". Matrix of Tukey's Pairwise honest significance test of lichen thickness by ecotype.",sep="")}

# Do the tukey test to get paired results
tukey = TukeyHSD(anova_result) #plot(TukeyHSD(anova_result, "Ecotype"))
tukeydf = as.data.frame(tukey$Ecotype) # Turn the tukey results into a data frame
tukeydf = cbind(EcotypeCombinations = rownames(tukeydf),tukeydf)# Move the row headers into a column
rownames(tukeydf) = NULL # Get rid of row headers

# Split the EcotypeCombinations column on -
tukeydf = tukeydf %>%
  mutate(EcotypeComparison = EcotypeCombinations) %>% # Copy the EcotypeCombinations column before we split it, otherwise it will disappear
  mutate(P = round(`p adj`,digits=3)) %>% # Round the p-adj column into a column named P
  separate(EcotypeCombinations,into=c("Ecotype1","Ecotype2"),sep="-") %>% # Split the EcotypeCombinations column into Ecotype1 and 2
  mutate(EcotypeComparison = paste(Ecotype1," <-> ",Ecotype2,sep="")) %>%
  arrange(diff)

# Make a column to hold asterisks for significant differences between Ecotype1 and 2
tukeydf$Sig = ""
tukeydf$Sig[tukeydf$`p adj` < 0.05] <- "*" 
tukeydf$Sig[tukeydf$`p adj` < 0.01] <- "**" 
tukeydf$Sig[tukeydf$`p adj` < 0.001] <- "***" 

# Make a matrix of p values
tukeymatrix = as.data.frame(acast(tukeydf, Ecotype1 ~ Ecotype2, value.var = "P"))
knitr::kable(tukeymatrix)
TableCounter = TableCounter + 1

```

```{r,label="Tukey test results plot",fig.cap=paste("Figure ",FigureCounter,". Comparison of Tukey's mean lichen height (cm) between ecotypes. Red points indicate no significant difference in lichen height at the 95% confidence level. The size of the point indicating probability of a difference. Mean lichen thickness between ecotypes increases toward the top and bottom of the plot while most similar ecotypes tend toward the middle.",sep=""),warning=FALSE}

# Create a ggplot
ggplot(tukeydf) +
  geom_errorbar(aes(y=reorder(EcotypeComparison,-diff),xmin=lwr,xmax=upr),color='gray60') +
  geom_point(aes(y=reorder(EcotypeComparison,-diff),x=diff,shape=Sig)) +
  #labs(shape='Significance') +
  scale_shape_manual( 
    name = "Significance", 
    values = c("NS" = 16, "*" = 17, "**" = 18, "***" = 19), # Adjust shapes as needed 
    labels = c("NS" = "Not Significant", "*" = "p < 0.05", "**" = "p < 0.01", "***" = "p < 0.001") ) +
  geom_vline(xintercept = 0, linetype = "dashed",color='gray70') +
  geom_text(aes(y=reorder(EcotypeComparison,-diff),x=diff,label=paste(round(diff,digits=2),"cm, (p=",format(P, nsmall = 2),")",Sig,sep="")),size=3, nudge_x = 2, nudge_y = 0) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ylab("Ecotypes compared") +
  xlab("Difference in mean lichen thickness (cm)") +
  xlim(-3,4.6) + 
  theme(legend.position = "bottom") +
  ggtitle("Comparison of mean lichen thickness\nbetween ecotypes")

# Increment the figure counter
FigureCounter = FigureCounter + 1
```

```{r}

# Create a sample data frame
df <- data.frame(
  x = c(1, 2, 3, 4, 5),
  y = c(3, 7, 4, 5, 6),
  group = c("A", "B", "A", "B", "A")
)

# Create a scatter plot and change the legend values using scale_color_manual()
ggplot(df, aes(x = x, y = y, color = group)) +
  geom_point(size = 5) +
  scale_color_manual(
    name = "Group",  # Change the legend title
    labels = c("Group A", "Group B"),  # Change the legend labels
    values = c("A" = "red", "B" = "blue")  # Specify colors for the groups
  ) +
  labs(title = "Scatter Plot with Custom Legend Labels",
       x = "X Axis",
       y = "Y Axis") +
  theme_minimal()


```

## Litter Depth and Composition

Each plot had 3 litter type and depth observations. This section assembles a list of all litter types encountered from the N,SE, and SW transects and counts how many observations there were for each to get at a percent of total litter observations per litter type.

```{r,label="Table: Litter dominance by transect", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Litter dominance (count of transects by litter type divided by total number of transects.",sep="")}

# Get a list of unique LitterTypes among the N,SE and SW transects so that we can count up how many observations there were for each litter type
UniqueLitterTypes = sqldf("SELECT DISTINCT NTransectLitterType As LitterType FROM Plots 
UNION 
SELECT DISTINCT SETransectLitterType FROM Plots
UNION 
SELECT DISTINCT SWTransectLitterType FROM Plots
")


Sql = "SELECT IFNULL(LitterType,'None') As  [Litter type]

-- Uncomment the columns below to see the counts of transects by litter type
,(SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.NTransectLitterType,'None') = IFNULL(d.LitterType,'None')) As NTransects
,(SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SWTransectLitterType,'None') = IFNULL(d.LitterType,'None')) As SWTransects
,(SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SETransectLitterType,'None') = IFNULL(d.LitterType,'None')) As SETransects

, (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.NTransectLitterType,'None') = IFNULL(d.LitterType,'None')) 
+ (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SWTransectLitterType,'None') = IFNULL(d.LitterType,'None'))
+ (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SETransectLitterType,'None') = IFNULL(d.LitterType,'None')) As SumOfTransects

,(SELECT Count(*) FROM Plots WHERE EstablishDate IS NOT NULL) * 3 As TotalNumberOfTransects

,CAST((
	 (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.NTransectLitterType,'None') = IFNULL(d.LitterType,'None')) 
	+ (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SWTransectLitterType,'None') = IFNULL(d.LitterType,'None'))
	+ (SELECT Count(*) FROM Plots p WHERE EstablishDate IS NOT NULL And IFNULL(p.SETransectLitterType,'None') = IFNULL(d.LitterType,'None')))
	As Float)
	/ (SELECT Count(*)* 3 FROM Plots WHERE EstablishDate IS NOT NULL) * 100
	As [% of transects]

FROM UniqueLitterTypes d
WHERE LitterType <> ''
ORDER BY [% of transects] DESC,LitterType
"

# Get the litter type counts dataset into a data frame
LitterType = sqldf(Sql)

# Print out the summary table
knitr::kable(sqldf("SELECT [Litter type],SumOfTransects as [Observations],[% of transects] FROM LitterType ORDER BY [% of transects] DESC"),digits=2)

# Get the total number of transects sampled into a parameter to us in the text
TotalTransects = LitterType[1,"TotalNumberOfTransects"]

```

`r TotalTransects` total transects.

## Caribou Ecotype Preference

```{r,label="Process and load the caribou ecotype preference dataset", echo=FALSE}
# Caribou ecotype preference dataset prep notes
# The idea was to overlay the chisana gps points over the map of ecotypes and count up the number of hits by ecotype to see
# where they spend their time.

# First I extracte the GPS data into a file as below
#EcoPref = read.csv("J:/Monitoring/Caribou/WRST/Projects/Chisana Caribou Habitat Assessment/Data/ChisanaGPSPointsByEcotype.csv")
 
# QC: The dates got messed up by R as usual, fix
#EcoPref$Date = as.Date(EcoPref$Date) # Make the dates actual dates
 
# Extract only the needed columns
#EcoPref = sqldf("SELECT AnimalId as Caribou,[Date],Lat_WGS84 as Lat,Lon_WGS84 as Lon,Month,Day,Season,Ecotype_2 as Ecotype FROM EcoPref ORDER BY AnimalId,Date")
 
# Join the lichen biomass data by ecotype
#EcoPref = merge(EcoPref,Biomass,by="Ecotype")
#EcoPref = sqldf("SELECT Caribou,Date,Ecotype,Lat,Lon,strftime('%Y',Date) As Year,Month,Day FROM EcoPref ORDER BY Caribou,Date")

# Write the GPS data to file
#Filename = paste("CV-10 Caribou Ecotype Preference Spatial Data SENSITIVE ",Sys.Date(),".csv",sep="")
#WriteDataFrameToFile(EcoPref,Filename)


#Read in the caribou ecotype preference dataset from the J drive
# This file is not available from Data Store because it has spatial 
EcoPrefPath = paste(DeliverablesDirectory,"CV-10 Caribou Ecotype Preference Spatial Data SENSITIVE 2024-11-14.csv",sep="")
EcoPref = read.csv(EcoPrefPath,header=TRUE)
# head(EcoPref)

# QC
# Make the dates real dates
EcoPref$Date = as.Date(EcoPref$Date)

# Get the earliest and latest GPS dates
# EcoPref %>% 
#   #group_by(Caribou) %>% 
#   summarize(
#     Earliest=min(Date),
#     Latest=max(Date),
#     #Days = as.numeric(difftime(max(Date), min(Date), units = "days")),
#     #Years = round(Days/365.25,digits=2),
#   ,Fixes=n()) %>%
#   arrange(Earliest)
# Result: 2020-04-13	2024-09-29	13929	
```

### Ecotype preference

```{r,label="Table: Ecotype preference of Chisana caribou", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Ecotype preference of Chisana caribou as determined from the number of GPS collar fixes by ecotype.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

Sql = "SELECT Ecotype
,Count(*) as [GPS fixes] 
,(SELECT Count(*) FROM EcoPref WHERE Ecotype IS NOT NULL and NOT Ecotype = '') as TotalFixes
,Cast(Count(*) As Float) / (SELECT Count(*) FROM EcoPref WHERE Ecotype IS NOT NULL and NOT Ecotype = '') * 100 as [Percent of total]
FROM EcoPref
WHERE Ecotype IS NOT NULL and NOT Ecotype = ''
GROUP BY Ecotype 
ORDER By Count(*) DESC"
PercentOfFixesByEcotype = sqldf(Sql)
knitr::kable(PercentOfFixesByEcotype %>% select(Ecotype,`GPS fixes`,`Percent of total`),digits=0)

# Get the total number of GPS fixes into a parameter that can be used in the text
TotalGPSFixes = PercentOfFixesByEcotype[1,'TotalFixes']

```

Total GPS fixes = `r TotalGPSFixes`

### Ecotype Preference By Month

```{r,label="Figure: Caribou seasonal ecotype preference", echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Caribou seasonal ecotype preference.",sep="")}
# By Month
Sql = "SELECT Month, Ecotype,Count(*) as [GPS Fixes]
FROM EcoPref
WHERE Ecotype IS NOT NULL and NOT Ecotype = ''
GROUP BY Month,Ecotype 
ORDER By Month, Count(*) DESC"
EcoPrefByMonth = sqldf(Sql)

# Break out the GPS fixes by month to see how the caribou spend their time seasonally
ggplot(EcoPrefByMonth) +
  geom_col(aes(x=Month,y=`GPS Fixes`,fill=Ecotype),position="fill") +
  ggtitle("Caribou seasonal ecotype preference") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(1, 12, by = 1)) 

```

## Fecal Pellet Composition

### Pellet composition by plant.

34 pellets total

```{r,label="Figure: Fecal pellet composition by taxa", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Fecal pellet composition by taxa having percent composition greater than one percent.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

Sql = "SELECT Plant,Avg(PctComposition) as [Mean % composition],Count(*) as n 
FROM PelletData 
GROUP BY Plant 
HAVING Avg(PctComposition) > 1
ORDER BY Avg(PctComposition) DESC"

PelletCompositionSummary = sqldf(Sql)
knitr::kable(PelletCompositionSummary,digits=1)

TotalPelletDataObservations = nrow(PelletCompositionSummary)

ggplot(data=PelletCompositionSummary) +
  geom_col(aes(x=reorder(Plant,-`Mean % composition`),y=`Mean % composition`)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  xlab("Taxa") +
  ylab("Mean % composition")

```

Total records = `r TotalPelletDataObservations`.

### Pellet percent composition by plant form.

```{r,label="Table: Fecal pellet composition by plant form", echo=FALSE,tab.cap=paste("Table ",TableCounter,". Fecal pellet composition by plant form.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

# Calculate the mean pellet composition by form
PelletCompositionSummaryByForm = PelletData %>% group_by(Sample,Form) %>% summarise(Sum=sum(PctComposition)) %>% arrange(Sample,desc(Sum)) %>%
 group_by(Form) %>%  summarize(Mean=mean(Sum),S.D.=sd(Sum),n=n()) %>% arrange(desc(Mean))

# Output the mean composition by form table
knitr::kable(PelletCompositionSummaryByForm,digits=1)

TotalPelletDataObservations = nrow(PelletCompositionSummary)

```

```{r,label="Figure: Fecal pellet composition by plant form", echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Fecal pellet composition by plant form.",sep="")}

ggplot(data=PelletCompositionSummaryByForm) +
  geom_col(aes(x=reorder(Form,-Mean),y=Mean)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  xlab("Plant form") +
  ylab("Mean % composition")

FigureCounter = FigureCounter + 1

```

Total records = `r TotalPelletDataObservations`.

# Discussion

## Vegetation Cover

Foliar cover is dominated by Betula glandulosa 17%, Unknown sedge, 12% Dryas octopetala, 9% and Salix spp. at 8%. Basal cover is overwhelmingly dominated by Moss, 42% Unknown sedges 6%, Cladonia sp. 5% Stereocaulon sp. 4% Cetraria sp. 3% Empetrum nigrum 3% Peltigera sp. 2%

### Lichen Layer Thickness and Biomass

Lichen layer thickness ranged from 0.83cm in riverine habitats to 1.7cm in the Alpine Sedge-Dwarf Shrub ecotype, excluding the Forest ecotype where we only had one sample with a mean thickness of 2.77 cm.

[It's interesting that caribou seem to avoid Forest ecotype even though it has the most lichen. Possibly deep snow, insects, or predation?]

### Litter Depth and Composition

### Caribou Ecotype Preference

Caribou seem to use the Alpine Sedge-Dwarf Shrub ecotype year round and this ecotype showed the thickest lichen layer of all ecotypes except the Forest ecotype.

Caribou show distinct seasonal use of the Alpine Dwarf Shrub/Barrens ecotype, migrating out in the winter and in during the summer. [Insect relief?]

### Fecal Pellet Composition

# Appendix A: Sampling Plots

## List Of Plots

```{r, echo=FALSE,tab.cap=paste("Table ",TableCounter,". Sampling plots.",sep="")}
# Increment the table counter
TableCounter = TableCounter + 1

knitr::kable(sqldf("SELECT Plot,Ecotype,EstablishDate,Elev_m as [Elevation (m)],Latitude,Longitude FROM Plots ORDER BY Plot"),caption='Table ?. Sampling plots.')

```

## Elevational Profiles

```{r, echo=FALSE,fig.cap=paste("Table ",TableCounter,". Sampling plots elevation profile by ecotype. Error bars represent the minimum and maximum plot elevation for each ecotype.",sep="")}

# Increment the table counter
TableCounter = TableCounter + 1

ggplot(sqldf("SELECT Ecotype,Avg(Elev_m) as [Mean elevation (m)],Min(Elev_m) as [Min. elevation (m)],Max(Elev_m) as [Max. elevation (m)] FROM Plots Group By Ecotype")) +
  geom_point(aes(x=reorder(Ecotype,`Mean elevation (m)`),y=`Mean elevation (m)`)) +
  geom_errorbar(aes(x=reorder(Ecotype,`Mean elevation (m)`),ymin=`Min. elevation (m)`,ymax=`Max. elevation (m)`)) +
  ggtitle(paste("Ecotypes elevation profile ",sep="")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ylab("Elevation (m)") +
  xlab("Ecotype")

```

```{r, echo=FALSE,fig.cap=paste("Figure ",FigureCounter,". Sampling plots elevation profile by plot.",sep="")}

ggplot(Plots) +
  geom_point(aes(x=reorder(Plot,Elev_m),y=Elev_m,shape=Ecotype,color=Ecotype)) +
  ggtitle(paste("Sampling plots elevation profile ",sep="")) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ylab("Elevation (m)") +
  xlab("Plot")

```

# Appendix B: Vegetation Summary By Ecotype

```{r, echo=FALSE, results='asis'}

# This code block generates a table of vegetation point intercept counts by plant species and ecotype and generates percent cover for each strata (TopCanpoy, Lower1-3, SoilSurface)
  
# Build the query
# Start by building a set of all ecotypes by all species
Sql = "SELECT e.Ecotype, s.ScientificName,s.GrowthHabitSub

--, (SELECT Count(*) FROM Dataset_VegData v WHERE v.Ecotype=e.Ecotype And  TRIM(v.Lower1)='')  as Lower1NullIntercepts -- Note: IS NULL doesn't seem to work as a filter on the Dataset_Veg data frame. The NULLs seem to have been converted to blanks when the data were read.csved  in from file

-- Now add in the counts of intercepts by stratum by species [UPPER() ensures that the species codes, which are sometimes inconsistent in case, match]
, (SELECT COUNT(TopCanopy) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.TopCanopy) = UPPER(s.SpeciesCode) And UPPER(v.TopCanopy) = UPPER(s.SpeciesCode))  as TopCanopyIntercepts

, (SELECT COUNT(Lower1) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower1) = UPPER(s.SpeciesCode)) as Lower1Intercepts

, (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower2) = UPPER(s.SpeciesCode)) as Lower2Intercepts
, (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower3) = UPPER(s.SpeciesCode)) as Lower3Intercepts

-- Sum the mid-story strata by adding the Lower1-3 strata intercept counts together
-- , (SELECT COUNT(Lower1) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower1) = UPPER(s.SpeciesCode))
-- 	  + (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower2) = UPPER(s.SpeciesCode))
-- 	  + (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower3) = UPPER(s.SpeciesCode))
-- 	as LowerInterceptsCombined

-- Count the number of soil surface intercepts for the current species
, (SELECT COUNT(SoilSurface) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.SoilSurface) = UPPER(s.SpeciesCode)) as SoilSurfaceIntercepts

-- Calculate foliar percent cover for each ecotype by dividing the intercepts by species by the number of possible intercepts
, CAST((SELECT COUNT(TopCanopy) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.TopCanopy) = UPPER(s.SpeciesCode)) As Float) 
  / (SELECT Count(*) as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) * 100
as PctCover_TopCanopy

-- Calculate Lower1 percent cover for each ecotype by dividing the intercepts by species by the number of possible intercepts
, CAST((SELECT COUNT(Lower1) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower1) = UPPER(s.SpeciesCode)) As Float) 
  / (SELECT Count(*) as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) * 100
as PctCover_Lower1

-- Calculate soil surface percent cover for each ecotype by dividing the intercepts by species by the number of possible intercepts
, CAST((SELECT COUNT(SoilSurface) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.SoilSurface) = UPPER(s.SpeciesCode)) As Float) 
  / (SELECT Count(*) as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) * 100
as PctCover_SoilSurface

-- Calculate mid-story (Lower1-3) percent cover for each ecotype by dividing the intercepts by species by the number of possible intercepts
-- NOTE: This doesn't work because Lower2 and 3 are essentially 'blocked' by Lower1, diminishing the odds of a 'hit'. The result calculated below gave misleading very lowe percent cover
--, CAST((SELECT COUNT(Lower1) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower1) = UPPER(s.SpeciesCode))
--	  + (SELECT COUNT(Lower2) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower2) = UPPER(s.SpeciesCode))
--	  + (SELECT COUNT(Lower3) AS n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype And UPPER(v.Lower3) = UPPER(s.SpeciesCode)) As Float)
--	  / (SELECT Count(*) * 3 as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) -- Multiply the denominator by 3 because there are three mid-story levels
--	   * 100 as PctCover_LowerInterceptsCombined

-- Total number of possible intercepts for each ecotype
,(SELECT Count(*) as n FROM Dataset_VegData v WHERE v.Ecotype = e.Ecotype) as TotalHitsPossible

FROM SpeciesList s
CROSS JOIN Ecotypes e
ORDER BY e.Ecotype, s.ScientificName"

# Execute the query into a data frame
CoverDataByEcotype = sqldf(Sql)
#write.table(CoverDataByEcotype,file="C:/temp/zCoverByEcotype.csv",quote=TRUE,row.names = FALSE,col.names=TRUE,sep=",")



```

```{r, echo=FALSE, results='asis'}

# Function to dump out a report section characterizing each ecotype
GetEcotypeSection = function(Ecotype){

    # Header and text
  cat("# ",Ecotype,"  \n\n")
  cat("  \n\n")
  
  
  # Ecotype description
  cat("## Distinguishing features and cover.  \n\n")
  EcotypeDescription = sqldf("SELECT Ecotype,DistinguishingFeatures as [Distinguishing features],Cover as [Percent of Chisana range] FROM Ecotypes WHERE Ecotype='Forest'")
  cat(EcotypeDescription$`Distinguishing features`," \n\n")
  cat("The",Ecotype,"ecotype covers approximately",EcotypeDescription[1,3],"% of the Chisana caribou herd range. \n\n")
  cat("  \n\n")
  
  
  
  
  # Plots in the ecotype and their sampling dates and attributes
  cat("## Sampling Plots.  \n\n")
  
  PlotSummary = sqldf(paste("SELECT DISTINCT Dataset_VegData.Plot,Plots.Elev_m as [Elevation (m)],Plots.EstablishDate as [Sampling Date]
    FROM Dataset_VegData 
    JOIN Plots on Plots.Plot = Dataset_VegData.Plot 
    WHERE Dataset_VegData.Ecotype = '",Ecotype,"' 
    ORDER BY Dataset_VegData.Plot",sep=""))
  # Add in a total row
  cat("  \n\n")
  cat("Table ",TableCounter,". Plots And sampling dates in the ",Ecotype," ecotype.  \n\n")
  print(knitr::kable(PlotSummary,digits=1))
  cat("  \n\n")
  cat("Mean elevation (m) = ",round(mean(PlotSummary$`Elevation (m)`),1),", number of plots = ",nrow(PlotSummary),"  \n\n")
  TableCounter = TableCounter + 1
  

  
  
  
  
  
  # Dump out the foliar cover
  cat("## Foliar Cover  \n\n")
  cat("Table ",TableCounter,". Plots And sampling dates in the ",Ecotype," ecotype.  \n\n")
  Sql = paste("SELECT ScientificName,TopCanopyIntercepts as Hits,TotalHitsPossible as Opportunities,CAST(PctCover_TopCanopy As Float) As [% cover] 
      FROM CoverDataByEcotype 
      WHERE Ecotype='",Ecotype,"' And [% cover] > 1 
      ORDER BY [% cover] DESC",sep="")
  Cover = sqldf(Sql)
  
  # Plot the foliar plant cover
  cat("  \n\n")
  print(
    ggplot(Cover) +
      geom_col(aes(x=reorder(ScientificName,-`% cover`),y=`% cover`)) +
      ggtitle(paste("Foliar Cover: ",Ecotype," Ecotype",sep="")) +
      theme_minimal() +
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
      xlab("Taxa") +
      ylab("% cover")
  )
  cat(" Figure ",FigureCounter,". Foliar percent cover in the ",Ecotype," ecotype having percent cover greater than 1%. X-axis taxa may include abiotic strata such as soil, litter or rock where no plant species were intercepted.  \n\n")
  cat("  \n\n")
  FigureCounter = FigureCounter + 1
  
  # Foliar plant cover summary table
  Cover[nrow(Cover) + 1,] = c("TOTAL",sum(Cover$Hits),'',sum(Cover$`% cover`))
  cat("Table ",TableCounter,". Foliar cover in the ",Ecotype," ecotype.  \n\n")
  print(knitr::kable(Cover,digits=1))
  cat("  \n\n")
  TableCounter = TableCounter + 1
  
  
  
  
  
  # Dump out the midstory cover. NOTE: The table below only considers Lower1 intercepts - ignores Lower2 and 3.
  # cat("## Mid-Story Cover  \n\n")
  # cat("  \n\n")
  # Sql = paste("SELECT ScientificName,Lower1Intercepts as Hits,TotalHitsPossible as Opportunities,CAST(PctCover_Lower1 As Float) As [% cover]
  #   FROM CoverDataByEcotype 
  #   WHERE Ecotype='",Ecotype,"' And [% cover] > 1 
  #   ORDER BY [% cover] DESC",sep="")
  # Cover = sqldf(Sql)
  # 
  #   # Plot the soil surface cover
  # cat("  \n\n")
  # print(
  #   ggplot(Cover) +
  #     geom_col(aes(x=reorder(ScientificName,-`% cover`),y=`% cover`)) +
  #     ggtitle(paste("Mid-story cover: ",Ecotype,sep="")) +
  #     theme_minimal() +
  #     theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  #     xlab("Taxa") +
  #     ylab("% cover")
  # )
  #   cat(" Figure ",FigureCounter,". Mid-story percent cover in the ",Ecotype," ecotype having percent cover greater than 1%. X-axis taxa may include abiotic strata such as soil, litter or rock where no plant species were intercepted.  \n\n")
  #   cat("  \n\n")
  #   FigureCounter = FigureCounter + 1
  # 
  # # Mid-story cover summary table
  # Cover[nrow(Cover) + 1,] = c("TOTAL",sum(Cover$Hits),'',sum(Cover$`% cover`))
  # cat("Table ",TableCounter,". Midstory cover in the ",Ecotype," ecotype.  \n\n")
  # print(knitr::kable(Cover,digits=1))
  # cat("  \n\n")
  # TableCounter = TableCounter + 1
  
  
  
  
  
  # Dump out the soil surface cover. NOTE: The table below only considers Lower1 intercepts - ignores Lower2 and 3.
  cat("## Soil Surface Cover  \n\n")
  cat("  \n\n")
  Sql = paste("SELECT ScientificName,SoilSurfaceIntercepts as Hits,TotalHitsPossible as Opportunities,CAST(PctCover_SoilSurface As Float) As [% cover] 
    FROM CoverDataByEcotype 
    WHERE Ecotype='",Ecotype,"' And [% cover] > 0 
    ORDER BY [% cover] DESC",sep="")
  Cover = sqldf(Sql)
  
  # Plot the soil surface cover
  cat("  \n\n")
  print(
    ggplot(Cover) +
      geom_col(aes(x=reorder(ScientificName,-`% cover`),y=`% cover`)) +
      ggtitle(paste("Soil surface cover: ",Ecotype,sep="")) +
      xlab("Point intercept") +
      theme_minimal() +
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
      xlab("Taxa") +
      ylab("% cover")
  )
  cat("  \n\n")
  cat(" Figure B-3. Soil surface percent cover in the ",Ecotype," ecotype having percent cover greater than 1%. X-axis taxa may include abiotic strata such as soil, litter or rock where no plant species were intercepted.  \n\n")
    cat("  \n\n")
    FigureCounter = FigureCounter + 1
  
  # Add in a total row and output
  Cover[nrow(Cover) + 1,] = c("TOTAL",sum(Cover$Hits),'',sum(Cover$`% cover`))
  cat("Table ",TableCounter,". Soil surface cover in the ",Ecotype," ecotype.  \n\n")
  print(knitr::kable(Cover,digits=1))
  cat("  \n\n")
  TableCounter = TableCounter + 1

}


# Loop through the ecotypes and generate a report section showing the vegetation composition, foliar, midstory and soil surface, etc.
Samples = sqldf("SELECT Ecotype FROM Ecotypes ORDER BY ECotype")
for(i in 1:nrow(Samples)) {       
  Ecotype = Ecotypes$Ecotype[i]
  GetEcotypeSection(Ecotype)
}

# GetEcotypeSection('Alpine Meadow')

```

# Appendix B: Fecal Pellet Results By Sample

```{r, echo=FALSE, results='asis'}
# Function to dump out a report section showing pellet composition
GetPelletCompositionSummary = function(Sample){
  
  # Header and text
  cat("## Fecal Pellet Sample ",Sample,"  \n\n")
  cat("  \n\n")
  cat("Fecal pellet composition summary:  \n\n")
  cat("  \n\n")
  
  # Get the percent composition of the pellet
  Sql = paste("SELECT Plant,Form,  PctComposition AS [Mean % composition]
  FROM PelletData
  WHERE Sample='",Sample,"' And PctComposition > 0
  ORDER BY Sample, PctComposition DESC",sep="")
  
  # Dump out the composition table
  cat("Table ",TableCounter,". Fecal pellect composition, ",Sample,"  \n\n")
  print(knitr::kable(sqldf(Sql)),digits=1)
  cat("  \n\n")
}

```

```{r, echo=FALSE,results='asis'}
# Loop through the Sample IDs and push out a summary to the report for each
Samples = sqldf("SELECT DISTINCT Sample FROM PelletData WHERE Sample IS NOT NULL ORDER BY Sample")
for(i in 1:nrow(Samples)) {       
  Sample = Samples$Sample[i]
  GetPelletCompositionSummary(Sample)
}

```

# References

Arseneault, D., Villeneuve, N., Boismenu, C., Leblanc, Y., & Deshaye, J. (1997). Estimating lichen biomass and caribou grazing on the wintering grounds of northern Quebec: An application of fire history and Landsat data. *Journal of Applied Ecology*, 65-78.

Boertje, R. D. (1984). Seasonal diets of the Denali caribou herd, Alaska. *Arctic*, 161-165.

Clarke, H., and M. Waterreus. (2012). Chisana caribou range lichen assessment, September, 2011. Yukon Fish and Wildlife Branch Report SR-12-01. Whitehorse, Yukon, Canada.

Collins, W. B., Dale, B. W., Adams, L. G., Mcelwain, D. E., & Joly, K. (2011). Fire, grazing history, lichen abundance, and winter distribution of caribou in Alaska's taiga. *The Journal of Wildlife Management*, *75*(2), 369-377.

Elzinga, C. L., Salzer, D. W., & Willoughby, J. W. (1998). Measuring & Monitoring Plant Populations. U.S. Bureau of Land Management Papers. Paper 17.

Farnell, R., & Gardner, C. (2002). Chisana caribou herd—2002. *Yukon Department of Environment, Whitehorse, Yukon, Canada*.

Fischer, L. A. (2002). Late winter resource selection and the potential for competition between wood bison and woodland caribou in the Yukon. Doctoral dissertation. The University of Calgary, Alberta.

Florkiewicz, R. F., Flynn, N., MacLean, N., Francis, S. R., Adamczewski, J. Z., & Loewen, V. (2004). *Little Rancheria Caribou in the Yukon: Evaluation of winter habitat quality and habitat use*. Department of Environment Report TR-03-03. Yukon Environment, Yukon.

Herrick, J. E., Van Zee, J. W., Havstad, K. M., Burkett, L. M., & Whitford, W. G. (2005). *Monitoring manual for grassland, shrubland and savanna ecosystems.* USDA-ARS Jornada Experimental.  Las Cruces, New Mexico

Joly, K., Cole, M. J., & Jandt, R. R. (2007). Diets of overwintering caribou, Rangifer tarandus, track decadal changes in Arctic tundra vegetation. *The Canadian Field-Naturalist*, *121*(4), 379-383.

Joly, K., Stuart Chapin III, F., & Klein, D. R. (2010). Winter habitat selection by caribou in relation to lichen abundance, wildfires, grazing, and landscape characteristics in northwest Alaska. *Ecoscience*, *17*(3), 321-333.

Johnson, H. L. (1994). Range Inventory and Monitoring following caribou reintroduction to the Nushagak Peninsula: A progress report of the Nushagak caribou vegetation study on the Togiak National Wildlife Refuge. US Fish and Wildlife Service progress report. Togiak National Wildlife Refuge, Dillingham. 144 pp.

Jorgenson, M. T., J. E. Roth, P. F. Loomis, E. R. Pullman, T. C. Cater, M. S. Duffy, W. A. Davis, and M. J. Macander. (2008). An ecological survey for landcover mapping of Wrangell-St. Elias National Park and Preserve. Natural Resource Technical Report NPS/WRST/NRTR—2008/094. National Park Service, Fort Collins, Colorado.

Moen, J., Danell, Ö., & Holt, R. (2009). Non-destructive estimation of lichen biomass. *Rangifer*, *27*(1).

Oosenbrug, S. M. (1976). *Range relationships and population dynamics of the Burwash Uplands caribou herd, Yukon Territory*. University of Waterloo, Department of Biology.

Oosenbrug, S. M., & Theberge, J. B. (1980). Altitudinal movements and summer habitat preferences of woodland caribou in the Kluane Ranges, Yukon Territory. *Arctic*, 59-72.

Posit team (2024). RStudio: Integrated Development Environment for R. Posit Software, PBC, Boston, MA. URL <http://www.posit.co/.>

Post, E., & Klein, D. R. (1999). Caribou calf production and seasonal range quality during a population decline. *The Journal of Wildlife Management*, 335-345.

R Core Team (2024). \_R: A Language and Environment for Statistical Computing\_. R Foundation for Statistical Computing, Vienna, Austria. <https://www.R-project.org/>.

Posit team (2024). RStudio: Integrated Development Environment for R. Posit Software, PBC, Boston, MA. URL <http://www.posit.co/.>

Swanson, J. D., & Barker, M. H. W. (1992). Assessment of Alaska reindeer populations and range conditions. *Rangifer*, *12*(1), 33-43.

Valkenburg, P. (1996). Population decline in the Delta caribou herd with reference to other Alaskan herds. *Rangifer*, *16*(4), 53-62.
