---
title: "A Range Quality Assessment for the Chisana Caribou Herd, Alaska"
author: "SDMiller"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(sqldf)
library(tidyverse)
library(odbc)
library(leaflet)
connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna_dev", Database = "ChisanaVegetation")


# Pull the vegetation dataset from the SQL Server database and write it to file for archival in NPS Data Store
Sql = "SELECT Plot 
, Line 
, PointLoc 
, TopCanopy 
, TopCanopyScientificName 
, TopCanopyCommonName 
, TopCanopyLifeForm 
, TopCanopyGrowthHabit 
, TopCanopyGrowthHabitSub 
, Lower1 
, Lower1ScientificName 
, Lower1CommonName 
, Lower1LifeForm 
, Lower1GrowthHabit 
, Lower1GrowthHabitSub 
, Lower2 
, Lower2ScientificName 
, Lower2CommonName 
, Lower2LifeForm 
, Lower2GrowthHabit 
, Lower2GrowthHabitSub 
, Lower3 
, Lower3ScientificName 
, Lower3CommonName 
, Lower3LifeForm 
, Lower3GrowthHabit 
, Lower3GrowthHabitSub 
, SoilSurface 
, SoilSurfaceScientificName 
, SoilSurfaceCommonName 
, SoilSurfaceLifeForm 
, SoilSurfaceGrowthHabit 
, SoilSurfaceGrowthHabitSub 
, SoilSurfaceDescription 
, LichenHeight 
, Ecotype 
, Lat 
, Lon 
, Elev_m 
, SlopePosition 
, SlopeLength 
, SlopeCrossSection 
, ParentRock 
, Drainage
, AvgPrecip
, AvgPrecipUOM
, EcolSite
, ParentMaterial
, MicroRelief
, MicroReliefSize
, GeoMorphicDisturbance
, EvidenceOfFrostAction
, MaxSlope
, EvidenceOfWind
, WindExposureClass
, CaribouSign
, EvidenceOfFire
, SlopeAsp
, Date
, Crew
, VersionDate 
FROM Dataset_VegData 
ORDER BY Plot, Line, PointLoc"
Data = dbGetQuery(connection,Sql)

# Write the vegetation data to file
ExportFile = paste("./VegData.csv",sep="")
write.table(Data,file=ExportFile,quote=FALSE,sep="|",na="",row.names = FALSE, col.names = TRUE)

```

# Intro

The Chisana Caribou Herd (CCH) is a small herd of woodland caribou located in northeastern Wrangell St. Elias (WRST) National Park and Preserve in Alaska and the Tetlin National Wildlife Refuge in the Yukon. During the early 1990s, many caribou herds in interior Alaska experienced population declines of varying severity (Valkenburg et al., 1996). From 1989 to 2001, the CCH population dropped from an estimated 1800 to 400 individuals (R. Farnell, unpublished data). The CCH became listed as a “Specially Protected” population in 2002 under the Yukon’s Federal Species at Risk Act. After the implementation of a captive rearing program and the development of an international, multiagency management plan, the CCH population is now stable and open to subsistence hunting. However, the current population is significantly below pre-decline levels. Several factors most likely contributed to the CCH population decline including predation, low recruitment, and poor habitat.

Lichens may be the greatest feature limiting CCH habitat quality. Lichens comprise up to 60-86% of the winter diets of Yukon woodland caribou herds, while moss makes up only 1-8%, as estimated from the microhistological analysis of fecal pellets (Farnell and Gardner, 2002). Relative to other Alaskan and Yukon caribou, the CCH appear to have a winter diet that is unusually and low in lichen (31%) and high in moss (51%). Overflight landcover assessments and collections from a limited number of plots suggest that lichen cover with the range is sparse and dominated by nutrient-poor Stereocaulon species (Clarke and Waterreus, 2012), an indicator of poor winter habitat for reindeer (Swanson and Barker, 1992). More data on lichen and moss cover with the CCH range are needed to corroborate these results. In addition to cover, lichen biomass is an important measurement of caribou forage quality. If overgrazing occurs, lichen biomass may not be correlated with lichen cover, and caribou have shown preference for regions with low lichen cover, but high lichen biomass (Collins et al., 2010). Lichen biomass is commonly estimated from mean lichen mat thickness (Lieb, 1994; Arseneault et al., 1997; Moen et al. 2007; Collins et al., 2010). Therefore, measuring lichen thickness and cover in the CCH range may capture key details for assessing winter habitat.

Summer forage is also an important component of caribou habitat. Low recruitment in caribou populations in the Southern Alaska Peninsula is thought to be due to a combination of low winter lichen availability and poor summer range quality (Post and Klein, 1999). Caribou summer diet is typically composed of grasses, sedges, forbs, and willows (Boertje, 1984). Manipulation experiments within the CCH range suggest that climate change may affect caribou summer forage quality and abundance (Lenart et al., 2002). In this study, we aim to establish baseline monitoring of vegetation within the CCH range. Secondly, we estimate lichen cover and biomass across the CCH range to assess habitat quality relative to those of other caribou, particularly the neighboring Kluane, Aishihik, and Nelchina herds. In this report, we describe results from first season of data collection, present preliminary findings, and offer recommendations for future study years.

# Methods


# Dataset Processing Description

Judy et al. did vegetation point intercept on plots in the Chisana caribou range, recording vegetation species contacted every half meter per line. This resulted in 40 intercepts per line X 3 lines = 120 intercepts per plot. They recorded intercepts at varying depths of vegetation from the canopy down to the soil surface. I added up all the intercepts on the line by species and divided by the total number of intercepts to arrive at a proportion of total hits by species. Hopefully this is as intended.

# Study Area

We focus on the core range of the CCH within WRST National Park and Preserve boundaries. This area forms the basin between the Wrangell, St. Elias, and Nutzotin Mountains, containing the Chisana and White Rivers and the historic town of Chisana. Study area limits were defined to include the bulk of CCH radio collar signals recorded between 1988 and 2015 (Fig. 1; J. Putera, unpublished data, 2015). The resulting area is 2795 km^2^ (1079 miles^2^ ) and contains moderate to high elevations, from 1000 - 2500 m (3281–8202 ft).


Figure 1. Defining the core range of the Chisana caribou herd in northeastern WRST Park and Preserve. Points are radio collar signals recorded from 1988 to 2015 during summer or winter seasons. The core range (yellow border) was selected to include the majority of radio signals within WRST (green border).

Figure 2. Major ecotypes within the Chisana caribou range in northeastern WRST Park and Preserve (Table 1). Map based on ecotype landcover developed by Jorgenson et al. (2008).

## Plots

33 plots total

```{r, echo=FALSE,tab.cap="Table 1. Baseline vegetation monitoring plots in the range of the Chisana caribou herd. Spatial coordinates are WGS 1984."}

# Get the sampling plots into a frame
Sql = "SELECT
Plots.Plot
,Ecotypes.Ecotype
, Plots.Elev_m as [Elevation (m)]
, Plots.Lat as Latitude
, Plots.Lon
As Longitude
FROM Plots INNER JOIN
 Ecotypes ON Plots.EcotypeID = Ecotypes.EcotypeID
ORDER BY Plots.Plot, Ecotypes.Ecotype"
Plots = dbGetQuery(connection,Sql)

# Write the Plots data to file
write.table(Plots,file="./Plots.csv",quote=FALSE,sep="|",na="",row.names = FALSE, col.names = TRUE)

# Display the plots
knitr::kable(Plots)
```

## Number of plots by ecotype

Why only one plot in Forest?

```{r, echo=FALSE, tab.cap="Table 2. 'Table 2. Number of plots by ecotype, with mean elevation.'."}

# Display the sampling plots

Sql="SELECT Ecotypes.Ecotype
, COUNT(*) AS n
, AVG(Plots.Elev_m) AS [Mean elevation (m)]
FROM Plots INNER JOIN
 Ecotypes ON Plots.EcotypeID = Ecotypes.EcotypeID
WHERE Plots.EstablishDate IS NOT NULL
GROUP BY Ecotypes.Ecotype
ORDER BY n DESC"
dbGetQuery(connection,Sql)
knitr::kable(sqldf("SELECT Ecotype, COUNT(DISTINCT Plot) AS Plots, AVG(Elev_m) AS [Mean elevation (m)] FROM Data GROUP BY Ecotype ORDER BY Plots DESC"))


```

## Map

A map of the plots is shown below:

```{r, echo=FALSE}

# Map the units in Leaflet
leaflet() %>%
  
  # Set the view and zoom levels
  setView(lng = mean(Plots$Longitude), lat = mean(Plots$Latitude), zoom = 9) %>%
  
  # Add WMS tiles
  addWMSTiles('https://basemap.nationalmap.gov:443/arcgis/services/USGSTopo/MapServer/WmsServer',layers = "0",options = WMSTileOptions(format = "image/png"))  %>%

  # Add the points
  addCircleMarkers(lng = Plots$Longitude, lat = Plots$Latitude, popup = Plots$Plot, color=) %>%
 
  # Label the units 
  addLabelOnlyMarkers(~Longitude,~Latitude, label = ~Plot, data = Plots,  labelOptions = labelOptions(noHide = TRUE))

```

# Vegetation Cover

```{r, echo=FALSE}
# Retrieve the percent cover calculations from the database into a data frame
CoverData = dbGetQuery(connection,"SELECT [ScientificName]
,[TopCanopyIntercepts]
,[Lower1Intercepts]
,[Lower2Intercepts]
,[Lower3Intercepts]
,[LowerInterceptsCombined]
,[SoilSurfaceIntercepts]
,[TotalHitsPossible]
,[PctCover_TopCanopy]
,[PctCover_Lower1]
,[PctCover_Lower2]
,[PctCover_Lower3]
,[PctCover_LowerInterceptsCombined]
,[PctCover_SoilSurface]
,[SpeciesCode]
,[GrowthHabitSub]
FROM [ChisanaVegetation].[dbo].[Summary_VegData_PercentCover]
--WHERE GrowthHabitSub <> 'Abiotic' -- Omit cover of litter, rock, soil, water, etc.
ORDER BY PctCover_TopCanopy DESC")

# Write the vegetation percent cover data to file
ExportFile = paste("./Cover.csv",sep="")
write.table(CoverData,file=ExportFile,quote=FALSE,sep="|",na="",row.names = FALSE, col.names = TRUE)

```

## Foliar cover

```{r, echo=FALSE,tab.cap="Figure 1. Percent foliar cover by taxa in the range of the Chisana caribou herd having cover greater than 1%."}
sqldf("SELECT ScientificName,PctCover_TopCanopy as [Foliar % cover] 
FROM CoverData 
WHERE GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic')
And PctCover_TopCanopy > 1
AND PctCover_TopCanopy > 0
ORDER BY PctCover_TopCanopy DESC")
```

## Mid-story Cover

```{r, echo=FALSE,tab.cap="Figure 1. Percent mid-story cover by taxa in the range of the Chisana caribou herd having cover greater than 0.1%."}
sqldf("SELECT ScientificName,PctCover_LowerInterceptsCombined as [Mid-story % cover] 
FROM CoverData 
WHERE GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic')
AND PctCover_LowerInterceptsCombined > 0.1
ORDER BY PctCover_LowerInterceptsCombined DESC")
```

## Basal Cover

```{r, echo=FALSE,tab.cap="Table x. Percent basal cover by taxa in the range of the Chisana caribou herd having cover greater than 0.1%."}

sqldf("SELECT ScientificName,PctCover_SoilSurface as [Basal % cover] 
FROM CoverData 
WHERE GrowthHabitSub NOT IN ('Moss','Lichen Crust','Abiotic')
AND PctCover_SoilSurface > 0.1
ORDER BY PctCover_SoilSurface DESC")

```

## Moss And Lichen Cover

```{r, echo=FALSE,tab.cap="Table x. Percent ground cover of moss and lichen in the range of the Chisana caribou herd."}

sqldf("SELECT ScientificName,PctCover_SoilSurface as [Basal % cover] 
FROM CoverData 
WHERE GrowthHabitSub IN ('Moss','Lichen Crust') And (GrowthHabitSub <> 'Abiotic')
AND PctCover_SoilSurface > 0
ORDER BY PctCover_SoilSurface DESC")

```

# Vegetation Cover By Ecotype

Next, I generated the same chart but parsed the results by ecotype (Jorgenson). Lichen crust is pronounced in the Alpine Meadow ecotype. It would be neat to see if the GPS collar data shows the caribou loitering in this ecotype.

```{r, echo=FALSE,fig.cap="Figure 2. Percent cover by plant growth habit and Jorgenson ecotype."}
# Plot the percent cover by ecotype
# ggplot(CoverData) +
#   geom_col(aes(x=Ecotype,y=PercentCover,fill=GrowthHabitSub),position='fill') +
#   theme_minimal() +
#   # Make X axis labels vertical
#   theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))

```

```{r, echo=FALSE}
# Stats for the previous figure
# knitr::kable(sqldf("select Ecotype,GrowthHabitSub
#   , avg(PercentCover) as Mean
#   , min(PercentCover) as Min
#   , max(PercentCover) as Max
#   , stdev(PercentCover) as SD
#   , count(PercentCover) as n
#   FROM CoverData 
#   group by EcoType, GrowthHabitSub 
#   order by EcoType,Mean DESC"),caption='Table 2. Mean ercent cover by plant growth habit and Jorgenson ecotype.')

```

# Lichen Height

```{r, echo=FALSE}

# Get the lichen height data
LichenHeightData = dbGetQuery(connection,"SELECT Ecotype, LichenHeight FROM Dataset_VegData ORDER BY Ecotype")
ggplot(LichenHeightData) +
  geom_boxplot(aes(x=Ecotype,y=LichenHeight)) +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) 

#LichenHeightByEcotype = dbGetQuery(connection,"SELECT        Ecotype, Min, Max, Mean, SD, n FROM Summary_VegData_LichenHeightByEcotype ORDER BY Mean DESC")
# ggplot(LichenHeightByEcotype) +
#   geom_col(aes(x=Ecotype,y=Mean)) +
#   geom_errorbar(aes(x=Ecotype,ymin=Mean-SD,ymax=Mean+SD)) +
#   #geom_boxplot(aes(x=Ecotype,y=Mean))
#   theme_minimal() +
#   theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) 
# 
# LichenHeightByEcotype

```

# Conclusion

I've only scratched the surface here but I think there are a great many things we can do with these data. Once I'm done with preliminary data analysis and dealing with data quality issues I'll post files to NPS Data Store.

# Appendix A: Sampling Plots

```{r, echo=FALSE}
knitr::kable(Plots,caption='Table ?. Sampling plots.')
```

# Database table and column descriptions

```{r, echo=FALSE}
Sql = "select distinct [Table],TableDescription from DatabaseColumnsDescriptions where left([table],1) <> 'z' and not [table] in ('sysdiagrams','DeliverablesSchedule','LifeFormCoverMeans')"
knitr::kable(dbGetQuery(connection,Sql),caption='Table ?. Database table descriptions.')
```

```{r, echo=FALSE}
Sql = "SELECT        [Table], [Column], ColumnDescription
FROM            DatabaseColumnsDescriptions
where left([table],1) <> 'z' and not [table] in ('sysdiagrams','DeliverablesSchedule','LifeFormCoverMeans')
ORDER BY [Table], [Column]"
knitr::kable(dbGetQuery(connection,Sql),caption='Table ?. Database columns descriptions.')

```

# Data Summary By Plot

```{r, echo=FALSE}
# Get the vegetation data
VegData = dbGetQuery(connection,"SELECT Plot, Line, PointLoc, Ecotype, TopCanopy, TopCanopyScientificName, TopCanopyCommonName, TopCanopyLifeForm, TopCanopyGrowthHabit, TopCanopyGrowthHabitSub, Lower1, Lower1ScientificName, 
 Lower1CommonName, Lower1LifeForm, Lower1GrowthHabit, Lower1GrowthHabitSub, Lower2, Lower2ScientificName, Lower2CommonName, Lower2LifeForm, Lower2GrowthHabit, Lower2GrowthHabitSub, Lower3, 
 Lower3ScientificName, Lower3CommonName, Lower3LifeForm, Lower3GrowthHabit, Lower3GrowthHabitSub, SoilSurface, SoilSurfaceScientificName, SoilSurfaceCommonName, SoilSurfaceLifeForm, SoilSurfaceGrowthHabit, 
 SoilSurfaceGrowthHabitSub, SoilSurfaceSpecies, SoilSurfaceSpeciesScientificName, SoilSurfaceSpeciesCommonName, SoilSurfaceSpeciesLifeForm, SoilSurfaceSpeciesGrowthHabit, SoilSurfaceSpeciesGrowthHabitSub, 
 SoilSurfaceDescription, LichenHeight, Lat, Lon, Year, Date, EcotypeID, Elev_m, SlopePosition, SlopeLength, SlopeCrossSection, ParentRock, Drainage, AvgPrecip, VersionDate, AvgPrecipUOM, EcolSite, ParentMaterial, 
 MicroRelief, MicroReliefSize, GeoMorphicDisturbance, EvidenceOfFrostAction, MaxSlope, EvidenceOfWind, WindExposureClass, CaribouSign, EvidenceOfFire, SlopeAsp, EstablishDate, Crew
FROM            Dataset_VegData
ORDER BY Plot, Line, PointLoc")



```

```{r, echo=FALSE}
GetPlotSummary = function(Plot){
  cat("## ",Plot,"\n\n")
  Sql = paste("SELECT * FROM Summary_VegData_LichenHeightByPlot WHERE Plot='",Plot,"'",sep="")
  cat("## ",Sql,"\n\n")
  print(dbGetQuery(connection,Sql))
  cat("\n\n")
}

```

```{r, results='asis', echo=FALSE}
GetPlotSummary("ADD5")

```
